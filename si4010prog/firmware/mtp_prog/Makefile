all: mtp_prog_generated.c

mtp_prog.ihx: mtp_prog.rel
mtp_prog.bin: mtp_prog.ihx
mtp_prog_generated.c: mtp_prog.bin

clean:
	@for f in mtp_prog; do \
		for e in bin ihx lnk lst map mem rel rst sym; do \
			rm -f $$f.$$e; \
		done; \
	done; \

#
# asx8051 is the assembler provided with the SDCC tools. The options provided to the assembler are:
# Option 	Purpose
#  l 	generates a list file
#  o 	generates an object file
#  ff 	flag reallocatable references by mode in listing file
#  g 	make undefined symbols be global
#  p 	disables listing pagination
#
# The "o" option is mandatory, as the linker requires list, object and symbol files to generate executables. The "ff" and "p" options generate a readable list file. The "g" option tells the assembler to not generate an error if it finds an undefined symbol that is not declared as external.
#
%.rel: %.asm
	/usr/bin/sdas8051 -wloffgp "$<"

#
# Option	Purpose
#  -i		Output Intel Hex
#  -m		Generate a map file
#  -b		Set base address of area
#  -e		end (= echo -e "\x2de", this to prevent echo from eating the '-e' option)
%.ihx: %.rel
	{ \
		echo "-i"; \
		echo "-m"; \
		echo "-w"; \
		echo "-b _DATA = 0x40"; \
		for f in $^; do \
			echo $$f ; \
		done ; \
		echo -e "\x2de" ; \
	} | sdld -c; echo; \

%.bin: %.ihx
	makebin -p < "$<" > "$@"

%_generated.c: %.bin
	@echo "Generating $@"; \
	{ \
		echo "/* WARNING: THIS FILE IS AUTO GENERATED BY THE MTP_PROG BUILD PROCESS */" ;\
		echo "// MTP_Prog firmware";\
		echo "const unsigned char mtp_prog_fw[] = {"; \
		xxd -i < "$<"; \
		echo "};"; \
		echo "// Address where to set breakpoint(eg. address of 'loop_breakpoint' label)" ;\
		sed -n 's/^[[:space:]]*00\([[:xdigit:]]*\)[[:space:]]*loop_breakpoint[[:space:]]*$$/#define MTP_PROG_BP_ADDR (0x\1)/p' "$*.map"; \
	} > "$@"
