/*
 * Copyright (C) 2005-2015 Darron Broad
 * All rights reserved.
 * 
 * This file is part of Pickle Microchip PIC ICSP.
 * 
 * Pickle Microchip PIC ICSP is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published
 * by the Free Software Foundation. 
 * 
 * Pickle Microchip PIC ICSP is distributed in the hope that it will be
 * useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
 * Public License for more details. 
 * 
 * You should have received a copy of the GNU General Public License along
 * with Pickle Microchip PIC ICSP. If not, see http://www.gnu.org/licenses/
 */

#include "pickle.h"

/******************************************************************************
 *
 * Session
 *
 *****************************************************************************/
extern struct pickle p;

/*****************************************************************************
 *
 * Hardware operations
 *
 *****************************************************************************/

struct pic_ops pic24_ops = {
	.arch				= ARCH24BIT,
	.align				= sizeof(uint32_t),
	.selector			= pic24_selector,
	.program_begin			= pic24_program_begin,
	.program_data			= pic24_program_data,
	.program_end			= pic24_program_end,
	.verify_begin			= pic24_program_verify,
	.verify_data			= pic24_verify_data,
	.verify_end			= pic24_standby,
	.view_data			= pic24_view_data,
	.read_config_memory		= pic24_read_config_memory,
	.get_program_size		= pic24_get_program_size,
	.get_data_size			= pic24_get_data_size,
	.get_executive_size		= pic24_get_executive_size,
	.get_boot_size			= NULL,
	.read_program_memory_block	= pic24_read_program_memory_block,
	.read_data_memory_block		= pic24_read_data_memory_block,
	.write_panel			= pic24_write_panel,
	.bulk_erase			= pic24_bulk_erase,
	.write_osccal			= NULL,
	.write_bandgap			= NULL,
	.write_calib			= NULL,
	.row_erase			= NULL,
	.dumpdeviceid			= pic24_dumpdeviceid,
	.dumpconfig			= pic24_dumpconfig,
	.dumposccal			= NULL,
	.dumpdevice			= pic24_dumpdevice,
	.dumpadj			= 2,
	.dumphexcode			= pic24_dumphexcode,
	.dumpinhxcode			= pic24_dumpinhxcode,
	.dumphexdata			= pic24_dumphexdata,
	.dumpinhxdata			= pic24_dumpinhxdata,
};

uint32_t
pic24_arch(void)
{
	p.pic = &pic24_ops;

	return p.pic->arch;
}

/*****************************************************************************
 *
 * Hardware configuration
 *
 *****************************************************************************/

struct pic24_config pic24_conf;

/*****************************************************************************
 *
 * Hardware algorithm map: Device
 *
 *****************************************************************************/

struct pic24_dsmap pic24_map[] =
{
/*Device name          Device id           Flash  EEPROM Data-sheet Config    #  Fuid #       Calib #      PanelSizes*/
/* These devices have 2 config words at the end of program flash */
{"PIC24FJ16GA002",     PIC24FJ16GA002,     5632,  0,     DS39786D,  0x002BFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ16GA004",     PIC24FJ16GA004,     5632,  0,     DS39786D,  0x002BFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ32GA002",     PIC24FJ32GA002,     11264, 0,     DS39786D,  0x0057FC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ32GA004",     PIC24FJ32GA004,     11264, 0,     DS39786D,  0x0057FC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ48GA002",     PIC24FJ48GA002,     16896, 0,     DS39786D,  0x0083FC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ48GA004",     PIC24FJ48GA004,     16896, 0,     DS39786D,  0x0083FC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ64GA002",     PIC24FJ64GA002,     22016, 0,     DS39786D,  0x00ABFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ64GA004",     PIC24FJ64GA004,     22016, 0,     DS39786D,  0x00ABFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ64GA006",     PIC24FJ64GA006,     22016, 0,     DS39786D,  0x00ABFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ64GA008",     PIC24FJ64GA008,     22016, 0,     DS39786D,  0x00ABFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ64GA010",     PIC24FJ64GA010,     22016, 0,     DS39786D,  0x00ABFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ96GA006",     PIC24FJ96GA006,     32768, 0,     DS39786D,  0x00FFFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ96GA008",     PIC24FJ96GA008,     32768, 0,     DS39786D,  0x00FFFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ96GA010",     PIC24FJ96GA010,     32768, 0,     DS39786D,  0x00FFFC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ128GA006",    PIC24FJ128GA006,    44032, 0,     DS39786D,  0x0157FC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ128GA008",    PIC24FJ128GA008,    44032, 0,     DS39786D,  0x0157FC, 2, 0,0,         0x8007F4, 6, 64,0},
{"PIC24FJ128GA010",    PIC24FJ128GA010,    44032, 0,     DS39786D,  0x0157FC, 2, 0,0,         0x8007F4, 6, 64,0},

/* These devices have 7 config words in the config space */
{"dsPIC30F2010",       dsPIC30F2010,       4096,  1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F2011",       dsPIC30F2011,       4096,  0,     DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F2012",       dsPIC30F2012,       4096,  0,     DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F3010",       dsPIC30F3010,       8192,  1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F3011",       dsPIC30F3011,       8192,  1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F3012",       dsPIC30F3012,       8192,  1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F3013",       dsPIC30F3013,       8192,  1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F3014",       dsPIC30F3014,       8192,  1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F4011",       dsPIC30F4011,       16384, 1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F4012",       dsPIC30F4012,       16384, 1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F4013",       dsPIC30F4013,       16384, 1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F5011",       dsPIC30F5011,       22528, 1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F5013",       dsPIC30F5013,       22528, 1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F5015",       dsPIC30F5015,       22528, 1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F5016",       dsPIC30F5016,       22528, 1024,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6010",       dsPIC30F6010,       49152, 4096,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6010A",      dsPIC30F6010A,      49152, 4096,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6011",       dsPIC30F6011,       45056, 2048,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6011A",      dsPIC30F6011A,      45056, 2048,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6012",       dsPIC30F6012,       49152, 4096,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6012A",      dsPIC30F6012A,      49152, 4096,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6013",       dsPIC30F6013,       45056, 2048,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6013A",      dsPIC30F6013A,      45056, 2048,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6014",       dsPIC30F6014,       49152, 4096,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6014A",      dsPIC30F6014A,      49152, 4096,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},
{"dsPIC30F6015",       dsPIC30F6015,       49152, 4096,  DS70102H,  0xF80000, 7, 0x8005C0,32, 0, 0,        32,16},

/* These devices have 2 config words at the end of program flash */
{"dsPIC33FJ16GP101",   dsPIC33FJ16GP101,   5632,  0,     DS70659C,  0x002BFC, 2, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ16GP102",   dsPIC33FJ16GP102,   5632,  0,     DS70659C,  0x002BFC, 2, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ32GP101",   dsPIC33FJ32GP101,   11264, 0,     DS70659C,  0x0057FC, 2, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ32GP102",   dsPIC33FJ32GP102,   11264, 0,     DS70659C,  0x0057FC, 2, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ32GP104",   dsPIC33FJ32GP104,   11264, 0,     DS70659C,  0x0057FC, 2, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ16MC101",   dsPIC33FJ16MC101,   5632,  0,     DS70659C,  0x002BFC, 2, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ16MC102",   dsPIC33FJ16MC102,   5632,  0,     DS70659C,  0x002BFC, 2, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ32MC101",   dsPIC33FJ32MC101,   11264, 0,     DS70659C,  0x0057FC, 2, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ32MC102",   dsPIC33FJ32MC102,   11264, 0,     DS70659C,  0x0057FC, 2, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ32MC104",   dsPIC33FJ32MC104,   11264, 0,     DS70659C,  0x0057FC, 2, 0, 0,        0, 0,        1, 0},

/* These devices have 8 config bytes at the end of program flash */
{"dsPIC33FJ06GS001",   dsPIC33FJ06GS001,   2048,  0,     DS70659C,  0x000FF0, 8, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ06GS101A",  dsPIC33FJ06GS101A,  2048,  0,     DS70659C,  0x000FF0, 8, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ06GS102A",  dsPIC33FJ06GS102A,  2048,  0,     DS70659C,  0x000FF0, 8, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ06GS202A",  dsPIC33FJ06GS202A,  2048,  0,     DS70659C,  0x000FF0, 8, 0, 0,        0, 0,        1, 0},
{"dsPIC33FJ09GS302",   dsPIC33FJ09GS302,   3072,  0,     DS70659C,  0x0017F0, 8, 0, 0,        0, 0,        1, 0},

{"PIC24F08KA101",      PIC24F08KA101,      2816,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KA101",      PIC24F16KA101,      5632,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KA102",      PIC24F08KA102,      2816,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KA102",      PIC24F16KA102,      5632,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV16KA301",     PIC24FV16KA301,     5632,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV16KA302",     PIC24FV16KA302,     5632,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV16KA304",     PIC24FV16KA304,     5632,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV32KA301",     PIC24FV32KA301,     11264, 512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV32KA302",     PIC24FV32KA302,     11264, 512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV32KA304",     PIC24FV32KA304,     11264, 512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KA301",      PIC24F16KA301,      5632,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KA302",      PIC24F16KA302,      5632,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KA304",      PIC24F16KA304,      5632,  512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F32KA301",      PIC24F32KA301,      11264, 512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F32KA302",      PIC24F32KA302,      11264, 512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F32KA304",      PIC24F32KA304,      11264, 512,   DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F04KA200",      PIC24F04KA200,      1408,  0,     DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,0},
{"PIC24F04KA201",      PIC24F04KA201,      1408,  0,     DS39919C,  0xF80000, 9, 0, 0,        0x8007F4, 6, 32,0},

{"PIC24F16KL402",      PIC24F16KL402,      5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KL401",      PIC24F16KL401,      5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KL402",      PIC24F08KL402,      2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KL401",      PIC24F08KL401,      2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KL302",      PIC24F08KL302,      2816,  256,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KL301",      PIC24F08KL301,      2816,  256,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KL201",      PIC24F08KL201,      2816,  0,     DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,0},
{"PIC24F08KL200",      PIC24F08KL200,      2816,  0,     DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,0},
{"PIC24F04KL101",      PIC24F04KL101,      1408,  0,     DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,0},
{"PIC24F04KL100",      PIC24F04KL100,      1408,  0,     DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,0},
{"PIC24FV16KM204",     PIC24FV16KM204,     5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV08KM204",     PIC24FV08KM204,     2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV16KM104",     PIC24FV16KM104,     5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV16KM202",     PIC24FV16KM202,     5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV08KM202",     PIC24FV08KM202,     2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV16KM102",     PIC24FV16KM102,     5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV08KM102",     PIC24FV08KM102,     2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24FV08KM101",     PIC24FV08KM101,     2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KM204",      PIC24F16KM204,      5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KM204",      PIC24F08KM204,      2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KM104",      PIC24F16KM104,      5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KM202",      PIC24F16KM202,      5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KM202",      PIC24F08KM202,      2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F16KM102",      PIC24F16KM102,      5632,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KM102",      PIC24F08KM102,      2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},
{"PIC24F08KM101",      PIC24F08KM101,      2816,  512,   DS30625D,  0xF80000, 8, 0, 0,        0x8007F4, 6, 32,1},

{"dsPIC33FJ06GS101",   dsPIC33FJ06GS101,   2048,  0,     DS70152H,  0xF80000, 8, 0xF80010, 2, 0x8007F4, 6, 64,0},
{"dsPIC33FJ06GS102",   dsPIC33FJ06GS102,   2048,  0,     DS70152H,  0xF80000, 8, 0xF80010, 2, 0x8007F4, 6, 64,0},
{"dsPIC33FJ06GS202",   dsPIC33FJ06GS202,   2048,  0,     DS70152H,  0xF80000, 8, 0xF80010, 2, 0x8007F4, 6, 64,0},
{"dsPIC33FJ16GS402",   dsPIC33FJ16GS402,   5632,  0,     DS70152H,  0xF80000, 8, 0xF80010, 2, 0x8007F4, 6, 64,0},
{"dsPIC33FJ16GS404",   dsPIC33FJ16GS404,   5632,  0,     DS70152H,  0xF80000, 8, 0xF80010, 2, 0x8007F4, 6, 64,0},
{"dsPIC33FJ16GS502",   dsPIC33FJ16GS502,   5632,  0,     DS70152H,  0xF80000, 8, 0xF80010, 2, 0x8007F4, 6, 64,0},
{"dsPIC33FJ16GS504",   dsPIC33FJ16GS504,   5632,  0,     DS70152H,  0xF80000, 8, 0xF80010, 2, 0x8007F4, 6, 64,0},

{"dsPIC33FJ32GS406",   dsPIC33FJ32GS406,   11264, 0,     DS70152H,  0xF80000, 9, 0, 0,        0x8007F4, 6, 64,0},
{"dsPIC33FJ32GS606",   dsPIC33FJ32GS606,   11264, 0,     DS70152H,  0xF80000, 9, 0, 0,        0x8007F4, 6, 64,0},
{"dsPIC33FJ32GS608",   dsPIC33FJ32GS608,   11264, 0,     DS70152H,  0xF80000, 9, 0, 0,        0x8007F4, 6, 64,0},
{"dsPIC33FJ32GS610",   dsPIC33FJ32GS610,   11264, 0,     DS70152H,  0xF80000, 9, 0, 0,        0x8007F4, 6, 64,0},
{"dsPIC33FJ64GS406",   dsPIC33FJ64GS406,   22016, 0,     DS70152H,  0xF80000, 9, 0, 0,        0x8007F4, 6, 64,0},
{"dsPIC33FJ64GS606",   dsPIC33FJ64GS606,   22016, 0,     DS70152H,  0xF80000, 9, 0, 0,        0x8007F4, 6, 64,0},
{"dsPIC33FJ64GS608",   dsPIC33FJ64GS608,   22016, 0,     DS70152H,  0xF80000, 9, 0, 0,        0x8007F4, 6, 64,0},
{"dsPIC33FJ64GS610",   dsPIC33FJ64GS610,   22016, 0,     DS70152H,  0xF80000, 9, 0, 0,        0x8007F4, 6, 64,0},

{"dsPIC33FJ12GP201",   dsPIC33FJ12GP201,   4096,  0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ12GP202",   dsPIC33FJ12GP202,   4096,  0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ16GP304",   dsPIC33FJ16GP304,   5632,  0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ32GP202",   dsPIC33FJ32GP202,   11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ32GP204",   dsPIC33FJ32GP204,   11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ32GP302",   dsPIC33FJ32GP302,   11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ32GP304",   dsPIC33FJ32GP304,   11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP202",   dsPIC33FJ64GP202,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP204",   dsPIC33FJ64GP204,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP206",   dsPIC33FJ64GP206,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP306",   dsPIC33FJ64GP306,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP310",   dsPIC33FJ64GP310,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP706",   dsPIC33FJ64GP706,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP708",   dsPIC33FJ64GP708,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP710",   dsPIC33FJ64GP710,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP802",   dsPIC33FJ64GP802,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP804",   dsPIC33FJ64GP804,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP202",  dsPIC33FJ128GP202,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP204",  dsPIC33FJ128GP204,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP206",  dsPIC33FJ128GP206,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP306",  dsPIC33FJ128GP306,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP310",  dsPIC33FJ128GP310,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP706",  dsPIC33FJ128GP706,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP708",  dsPIC33FJ128GP708,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP710",  dsPIC33FJ128GP710,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP802",  dsPIC33FJ128GP802,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP804",  dsPIC33FJ128GP804,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256GP506",  dsPIC33FJ256GP506,  87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256GP510",  dsPIC33FJ256GP510,  87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256GP710",  dsPIC33FJ256GP710,  87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ12MC201",   dsPIC33FJ12MC201,   4096,  0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ12MC202",   dsPIC33FJ12MC202,   4096,  0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ16MC304",   dsPIC33FJ16MC304,   5632,  0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ32MC202",   dsPIC33FJ32MC202,   11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ32MC204",   dsPIC33FJ32MC204,   11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ32MC302",   dsPIC33FJ32MC302,   11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ32MC304",   dsPIC33FJ32MC304,   11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC202",   dsPIC33FJ64MC202,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC204",   dsPIC33FJ64MC204,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC506",   dsPIC33FJ64MC506,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC508",   dsPIC33FJ64MC508,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC510",   dsPIC33FJ64MC510,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC706",   dsPIC33FJ64MC706,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC710",   dsPIC33FJ64MC710,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC802",   dsPIC33FJ64MC802,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC804",   dsPIC33FJ64MC804,   22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC202",  dsPIC33FJ128MC202,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC204",  dsPIC33FJ128MC204,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC506",  dsPIC33FJ128MC506,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC510",  dsPIC33FJ128MC510,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC706",  dsPIC33FJ128MC706,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC708",  dsPIC33FJ128MC708,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC710",  dsPIC33FJ128MC710,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC802",  dsPIC33FJ128MC802,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC804",  dsPIC33FJ128MC804,  44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256MC510",  dsPIC33FJ256MC510,  87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256MC710",  dsPIC33FJ256MC710,  87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ12GP201",     PIC24HJ12GP201,     4096,  0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ12GP202",     PIC24HJ12GP202,     4096,  0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ16GP304",     PIC24HJ16GP304,     5632,  0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ32GP202",     PIC24HJ32GP202,     11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ32GP204",     PIC24HJ32GP204,     11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ32GP302",     PIC24HJ32GP302,     11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ32GP304",     PIC24HJ32GP304,     11264, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP202",     PIC24HJ64GP202,     22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP204",     PIC24HJ64GP204,     22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP206",     PIC24HJ64GP206,     22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP210",     PIC24HJ64GP210,     22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP502",     PIC24HJ64GP502,     22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP504",     PIC24HJ64GP504,     22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP506",     PIC24HJ64GP506,     22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP510",     PIC24HJ64GP510,     22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP202",    PIC24HJ128GP202,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP204",    PIC24HJ128GP204,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP206",    PIC24HJ128GP206,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP210",    PIC24HJ128GP210,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP306",    PIC24HJ128GP306,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP310",    PIC24HJ128GP310,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP502",    PIC24HJ128GP502,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP504",    PIC24HJ128GP504,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP506",    PIC24HJ128GP506,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP510",    PIC24HJ128GP510,    44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ256GP206",    PIC24HJ256GP206,    87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ256GP210",    PIC24HJ256GP210,    87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ256GP610",    PIC24HJ256GP610,    87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP206A",  dsPIC33FJ64GP206A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP306A",  dsPIC33FJ64GP306A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP310A",  dsPIC33FJ64GP310A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP706A",  dsPIC33FJ64GP706A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP708A",  dsPIC33FJ64GP708A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64GP710A",  dsPIC33FJ64GP710A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC506A",  dsPIC33FJ64MC506A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC508A",  dsPIC33FJ64MC508A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC510A",  dsPIC33FJ64MC510A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC706A",  dsPIC33FJ64MC706A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ64MC710A",  dsPIC33FJ64MC710A,  22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP206A",    PIC24HJ64GP206A,    22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP210A",    PIC24HJ64GP210A,    22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP506A",    PIC24HJ64GP506A,    22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ64GP510A",    PIC24HJ64GP510A,    22016, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP206A", dsPIC33FJ128GP206A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP306A", dsPIC33FJ128GP306A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP310A", dsPIC33FJ128GP310A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP706A", dsPIC33FJ128GP706A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP708A", dsPIC33FJ128GP708A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128GP710A", dsPIC33FJ128GP710A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC506A", dsPIC33FJ128MC506A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC510A", dsPIC33FJ128MC510A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC706A", dsPIC33FJ128MC706A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC708A", dsPIC33FJ128MC708A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ128MC710A", dsPIC33FJ128MC710A, 44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP206A",   PIC24HJ128GP206A,   44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP210A",   PIC24HJ128GP210A,   44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP306A",   PIC24HJ128GP306A,   44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP310A",   PIC24HJ128GP310A,   44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP506A",   PIC24HJ128GP506A,   44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ128GP510A",   PIC24HJ128GP510A,   44032, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256GP506A", dsPIC33FJ256GP506A, 87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256GP510A", dsPIC33FJ256GP510A, 87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256GP710A", dsPIC33FJ256GP710A, 87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256MC510A", dsPIC33FJ256MC510A, 87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"dsPIC33FJ256MC710A", dsPIC33FJ256MC710A, 87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ256GP206A",   PIC24HJ256GP206A,   87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ256GP210A",   PIC24HJ256GP210A,   87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},
{"PIC24HJ256GP610A",   PIC24HJ256GP610A,   87552, 0,     DS70152H,  0xF80000, 8, 0xF80010, 4, 0, 0,        64,0},

{"PIC24EP32GP202",     PIC24EP32GP202,     11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP32GP203",     PIC24EP32GP203,     11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP32GP204",     PIC24EP32GP204,     11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP32GP502",   dsPIC33EP32GP502,   11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP32GP503",   dsPIC33EP32GP503,   11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP32GP504",   dsPIC33EP32GP504,   11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP32MC202",     PIC24EP32MC202,     11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP32MC203",     PIC24EP32MC203,     11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP32MC204",     PIC24EP32MC204,     11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP32MC202",   dsPIC33EP32MC202,   11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP32MC203",   dsPIC33EP32MC203,   11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP32MC204",   dsPIC33EP32MC204,   11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP32MC502",   dsPIC33EP32MC502,   11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP32MC503",   dsPIC33EP32MC503,   11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP32MC504",   dsPIC33EP32MC504,   11264, 0,     DS70663D,  0x0057EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP64GP202",     PIC24EP64GP202,     22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP64GP203",     PIC24EP64GP203,     22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP64GP204",     PIC24EP64GP204,     22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP64GP206",     PIC24EP64GP206,     22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64GP502",   dsPIC33EP64GP502,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64GP503",   dsPIC33EP64GP503,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64GP504",   dsPIC33EP64GP504,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64GP506",   dsPIC33EP64GP506,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP64MC202",     PIC24EP64MC202,     22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP64MC203",     PIC24EP64MC203,     22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP64MC204",     PIC24EP64MC204,     22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP64MC206",     PIC24EP64MC206,     22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64MC202",   dsPIC33EP64MC202,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64MC203",   dsPIC33EP64MC203,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64MC204",   dsPIC33EP64MC204,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64MC206",   dsPIC33EP64MC206,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64MC502",   dsPIC33EP64MC502,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64MC503",   dsPIC33EP64MC503,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64MC504",   dsPIC33EP64MC504,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP64MC506",   dsPIC33EP64MC506,   22528, 0,     DS70663D,  0x00AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP128GP202",    PIC24EP128GP202,    44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP128GP204",    PIC24EP128GP204,    44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP128GP206",    PIC24EP128GP206,    44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP128GP502",  dsPIC33EP128GP502,  44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP128GP504",  dsPIC33EP128GP504,  44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP128GP506",  dsPIC33EP128GP506,  44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP128MC202",    PIC24EP128MC202,    44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP128MC204",    PIC24EP128MC204,    44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP128MC206",    PIC24EP128MC206,    44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP128MC202",  dsPIC33EP128MC202,  44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP128MC204",  dsPIC33EP128MC204,  44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP128MC206",  dsPIC33EP128MC206,  44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP128MC502",  dsPIC33EP128MC502,  44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP128MC504",  dsPIC33EP128MC504,  44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP128MC506",  dsPIC33EP128MC506,  44032, 0,     DS70663D,  0x0157EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP256GP202",    PIC24EP256GP202,    88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP256GP204",    PIC24EP256GP204,    88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP256GP206",    PIC24EP256GP206,    88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP256GP502",  dsPIC33EP256GP502,  88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP256GP504",  dsPIC33EP256GP504,  88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP256GP506",  dsPIC33EP256GP506,  88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP256MC202",    PIC24EP256MC202,    88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP256MC204",    PIC24EP256MC204,    88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP256MC206",    PIC24EP256MC206,    88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP256MC202",  dsPIC33EP256MC202,  88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP256MC204",  dsPIC33EP256MC204,  88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP256MC206",  dsPIC33EP256MC206,  88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP256MC502",  dsPIC33EP256MC502,  88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP256MC504",  dsPIC33EP256MC504,  88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP256MC506",  dsPIC33EP256MC506,  88064, 0,     DS70663D,  0x02AFEC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP512GP202",    PIC24EP512GP202,    175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP512GP204",    PIC24EP512GP204,    175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP512GP206",    PIC24EP512GP206,    175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP512GP502",  dsPIC33EP512GP502,  175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP512GP504",  dsPIC33EP512GP504,  175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP512GP506",  dsPIC33EP512GP506,  175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP512MC202",    PIC24EP512MC202,    175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP512MC204",    PIC24EP512MC204,    175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"PIC24EP512MC206",    PIC24EP512MC206,    175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP512MC202",  dsPIC33EP512MC202,  175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP512MC204",  dsPIC33EP512MC204,  175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP512MC206",  dsPIC33EP512MC206,  175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP512MC502",  dsPIC33EP512MC502,  175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP512MC504",  dsPIC33EP512MC504,  175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},
{"dsPIC33EP512MC506",  dsPIC33EP512MC506,  175104,0,     DS70663D,  0x0557EC,10, 0x800FF8, 4, 0, 0,        2,0},

{"dsPIC30F1010",       dsPIC30F1010,       2048,  0,     DS70284B,  0xF80000, 8, 0x8005C0,32, 0, 0,        32,0},
{"dsPIC30F2020",       dsPIC30F2020,       4096,  0,     DS70284B,  0xF80000, 8, 0x8005C0,32, 0, 0,        32,0},
{"dsPIC30F2023",       dsPIC30F2023,       4096,  0,     DS70284B,  0xF80000, 8, 0x8005C0,32, 0, 0,        32,0},

{"PIC24FJ16MC101",     PIC24FJ16MC101,     5632,  0,     DS75012B,  0x002BFC, 2, 0, 0,        0, 0,        1, 0},
{"PIC24FJ16MC102",     PIC24FJ16MC102,     5632,  0,     DS75012B,  0x002BFC, 2, 0, 0,        0, 0,        1, 0},
{"PIC24FJ32MC101",     PIC24FJ32MC101,     11264, 0,     DS75012B,  0x0057FC, 2, 0, 0,        0, 0,        1, 0},
{"PIC24FJ32MC102",     PIC24FJ32MC102,     11264, 0,     DS75012B,  0x0057FC, 2, 0, 0,        0, 0,        1, 0},
{"PIC24FJ32MC104",     PIC24FJ32MC104,     11264, 0,     DS75012B,  0x0057FC, 2, 0, 0,        0, 0,        1, 0},

{"PIC24FJ32GA102",     PIC24FJ32GA102,     11264, 0,     DS39934B,  0x0057F8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ64GA102",     PIC24FJ64GA102,     22016, 0,     DS39934B,  0x00ABF8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ32GA104",     PIC24FJ32GA104,     11264, 0,     DS39934B,  0x0057F8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ64GA104",     PIC24FJ64GA104,     22016, 0,     DS39934B,  0x00ABF8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ32GB002",     PIC24FJ32GB002,     11264, 0,     DS39934B,  0x0057F8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ64GB002",     PIC24FJ64GB002,     22016, 0,     DS39934B,  0x00ABF8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ32GB004",     PIC24FJ32GB004,     11264, 0,     DS39934B,  0x0057F8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ64GB004",     PIC24FJ64GB004,     22016, 0,     DS39934B,  0x00ABF8, 4, 0,0,         0x800880, 8, 64,0},

{"PIC24FJ64GA204",     PIC24FJ64GA204,     22016, 0,  DS30000510E,  0x00ABF8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ64GA202",     PIC24FJ64GA202,     22016, 0,  DS30000510E,  0x00ABF8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ64GB204",     PIC24FJ64GB204,     22016, 0,  DS30000510E,  0x00ABF8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ64GB202",     PIC24FJ64GB202,     22016, 0,  DS30000510E,  0x00ABF8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ128GA204",    PIC24FJ128GA204,    44032, 0,  DS30000510E,  0x0157F8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ128GA202",    PIC24FJ128GA202,    44032, 0,  DS30000510E,  0x0157F8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ128GB204",    PIC24FJ128GB204,    44032, 0,  DS30000510E,  0x0157F8, 4, 0,0,         0x800880, 8, 64,0},
{"PIC24FJ128GB202",    PIC24FJ128GB202,    44032, 0,  DS30000510E,  0x0157F8, 4, 0,0,         0x800880, 8, 64,0},

{"(null)",             0,                  0,     0,     0,         0,        0, 0, 0,        0, 0,        0, 0},
/*Device name          Device id           Flash  EEPROM Data-sheet Config    #  Fuid #       Calib #      PanelSizes*/
};
#define PIC24_SIZE ((sizeof(pic24_map) / sizeof(struct pic24_dsmap)) - 1)

/* Default device (null) */
uint32_t pic24_index = PIC24_SIZE;

void
pic24_selector(void)
{
	uint32_t i;
	char *dnames[PIC24_SIZE];

	for (i = 0; i < PIC24_SIZE; ++i) {
		dnames[i] = pic24_map[i].devicename;
	}
	qsort(dnames, PIC24_SIZE, sizeof(char *), pic_cmp);
	for (i = 0; i < PIC24_SIZE; ++i) {
		if ((i % PIC_NCOLS) == (PIC_NCOLS - 1))
			printf("%s\n", dnames[i]);
		else
			printf("%-19s", dnames[i]);
	}
	if (i % PIC_NCOLS)
		printf("\n");
	printf("Total: %u\n", (uint32_t)PIC24_SIZE);
}

/*****************************************************************************
 *
 * Hardware algorithm map: Device family
 *
 *****************************************************************************/

struct pic24_dstab pic24_tab[] =
{
	/* EOF */
	{0, "(null)"},
};

/*****************************************************************************
 *
 * Program/Verify mode
 *
 *****************************************************************************/

/*
 * ENTER HVP/LVP PROGRAM/VERIFY MODE
 *
 * ENTRY - VDD FIRST
 *
 * DS39768D-page 15 PIC24FJ64GA002
 * DS70102H-page 68 dsPIC30F4013
 *
 * NOTES: EXIT THE RESET VECTOR (SOME ASSUMPTIONS)
 *
 *  ON RESET THE DEVICE EFFECTIVELY PERFORMS A GOTO 0
 *  AND WE MAY ASSUME THAT WHAT IS CALLED THE `FORCED NOP'
 *  IN THE DOCUMENTATION IS THE EXECUTION OF THE GOTO 0
 *  INSTRUCTION.
 *
 *  ON MOST dsPIC/PIC24 DEVICES, GOTO REQUIRES TWO CYCLES BUT
 *  ON dsPIC33E/PIC24E IT DEMANDS FOUR, THIS MEANS ON RESET WE
 *  NEED A DIFFERENT NUMBER OF GOTO NOPS.
 *
 *  ON LVP DEVICES THE INTIAL `FORCED NOP' IS 4+1 CLOCK CYCLES
 *  RATHER THAN 4+24 LONG, HOWEVER, THIS ISN'T DOCUMENTED AS
 *  SUCH IN THE MICROCHIP DATA-SHEET AND THIS IS JUST AN
 *  OBSERVATION.
 *
 *  AFTER RESET WE PERFORM A SINGLE `FORCED NOP' (WHICH MAY
 *  BE SHORT) AND THAT IS THE GOTO 0 INSTRUCTION, NEXT WE
 *  PERFORM EITHER ONE NOP TO COMPLETE THE INSTRUCTION FOR
 *  dsPIC/PIC24 ELSE THREE NOPS FOR dsPIC33E/PIC24E.
 *
 *  ONCE THE FORCED NOPS ARE COMPLETED WE MUST GOTO
 *  CODE ORIGIN WHICH IS NORMALLY 200 BUT WAS 100 ON
 *  THE FIRST dsPIC/PIC24 DEVICES. FAILURE TO JUMP NORMALLY
 *  RESULTS IN A CPU CRASH.
 */
void
pic24_program_verify(void)
{
	/* RESET & ACQUIRE GPIO */
	io_set_vpp(LOW);
	/* DS39768D    PIC24FJ64GA002    P6(100ns) */
	/* DS70102H    dsPIC30F4013      P6(100ns) */
	/* DS70663D    dsPIC33EP128GP502 P6(100ns) */
	/* DS30000510E PIC24FJXXXGA2/GB2 P6(100ns) */
	io_usleep(1000);

	/* PGD + PGC + PGM(N/A) LOW */
	io_set_pgd(LOW);
	io_set_pgc(LOW);
	io_set_pgm(LOW);
	io_usleep(1000);

	/* LVP(KEY) */
	if (p.key == LVPKEY) {
		/* INPUT DATA ON CLOCK FALLING EDGE */
		/* DS39768D-page 14 PIC24FJ64GA002 */
		io_configure(TRUE);

		/* VPP HIGH */
		io_set_vpp(HIGH);
		/* DS39768D    PIC24FJ64GA002    UNKNOWN    */
		/* DS70663D    dsPIC33EP128GP502 P21(500us) */
		/* DS30000510E PIC24FJXXXGA2/GB2 UNKNOWN    */
		io_usleep(500);

		/* VPP LOW */
		io_set_vpp(LOW);
		/* DS39768D    PIC24FJ64GA002    P18(40ns) */
		/* DS70663D    dsPIC33EP128GP502 P18(1ms)  */
		/* DS30000510E PIC24FJXXXGA2/GB2 P18(10ms) */
		io_usleep(10000);

		/* PROGRAM/VERIFY ENTRY CODE */
		io_program_out(QHCMKEY, 32);
		/* DS39768D    PIC24FJ64GA002    P19(1ms)  */
		/* DS70663D    dsPIC33EP128GP502 P19(25ns) */
		/* DS30000510E PIC24FJXXXGA2/GB2 P19(1ms)  */
		io_usleep(1000);

		/* VPP HIGH */
		io_set_vpp(HIGH);
		/* DS39768D    PIC24FJ64GA002    P7(25ms)      */
		/* DS70663D    dsPIC33EP128GP502 P7(50ms)  +   */
		/* DS70663D    dsPIC33EP128GP502 P1(200ns) x 5 */
		/* DS30000510E PIC24FJXXXGA2/GB2 P7(25ms)      */
		io_usleep(50001);
	
		/*
		 * STEP 1: EXIT THE RESET VECTOR (GOTO 0)
		 * 	NOP (5)
		 *	NOP
		 *	NOP, NOP (dsPIC33E/PIC24E)
		 *	GOTO 200 (CODE ORIGIN)
		 *	NOP
		 *	NOP, NOP (dsPIC33E/PIC24E)
		 */

		/* DS39768D-page 13 PIC24FJ64GA002 */
		/* NOP (5)              */
		/* NOP (28) [,NOP, NOP] */
		io_program_out(0, 5 + pic24_conf.gotonop * 28);

		/* GOTO 200, NOP [,NOP, NOP] */
		pic24_goto200();
	}
	/* HVP(KEY) */
	else if (p.key == HVPKEY) {
		/* INPUT DATA ON CLOCK FALLING EDGE */
		/* DS30625D-page 9 PIC24F16KL402 */
		io_configure(TRUE);

		/* VPP HIGH */
		io_set_vpp(HIGH);
		/* DS30625D PIC24F16KL402  P18(40ns) */
		/* DS39919B PIC24FV32KA302 P18(1ms)  */
		io_usleep(1000);

		/* PROGRAM/VERIFY ENTRY CODE */
		io_program_out(QHCMKEY, 32);
		/* DS30625D PIC24F16KL402  P7(25ms) */
		/* DS39919B PIC24FV32KA302 P7(25ms) */
		io_usleep(25000); /* 25ms */

		/*
		 * STEP 1: EXIT THE RESET VECTOR (GOTO 0)
		 *	NOP (5)
		 *	NOP
		 *	GOTO 200 (CODE ORIGIN)
		 *	NOP
		 */

		/* DS39625D-page 10 PIC24F16KL402 */
		/* NOP (5)  */
		/* NOP (28) */
		io_program_out(0, 5 + 28);

		/* GOTO 200, NOP */
		pic24_goto200();
	}
	/* HVP(STDP) */
	else {
		/* INPUT DATA ON CLOCK RISING EDGE */
		io_configure(FALSE);

		/* VPP HIGH */
		io_set_vpp(HIGH);
		/* DS70102H dsPIC30F4013 UNNAMED(25ms) */
		io_usleep(25000); /* 25ms */

		/*
		 * STEP 1: EXIT THE RESET VECTOR (GOTO 0)
		 *	NOP
		 *	NOP
		 *	GOTO 100 (CODE ORIGIN)
		 *	NOP
		 */

		/* DS70102H-page 69 dsPIC30F4013 */
		/* NOP (28) */
		/* NOP (28) */
		io_program_out(0, 28 + 28);

		/* GOTO 200, NOP */
		pic24_goto200();
	}
}

/*
 * EXIT HVP/LVP PROGRAM/VERIFY MODE
 *
 * EXIT - VDD LAST
 */
void
pic24_standby(void)
{
	/* PGD + PGC + VPP + PGM(N/A) LOW */
	io_set_pgd(LOW);
	io_set_pgc(LOW);
	io_set_vpp(LOW);
	io_set_pgm(LOW);
}

/*****************************************************************************
 *
 * Hardware functions
 *
 *****************************************************************************/

/*
 * 0000
 *
 * SIX (SHIFT IN 24-BIT INSTRUCTION AND EXECUTE)
 */
static inline void
pic24_six(uint32_t data, uint8_t nops)
{
	io_program_out(0x0, 4);		/* SIX        */
	io_program_out(data, 24);
	if (nops)
		io_program_out(0, 28 * nops);/* NOP [,NOP] */
}

/*
 * 0001
 *
 * REGOUT (SHIFT OUT THE VISI REGISTER)
 */
static inline uint16_t
pic24_regout(void)
{
	uint16_t word;

	io_program_out(0x1, 4);		/* REGOUT */
	word = io_program_in(24) >> 8;	/* VISI   */
	io_program_out(0, 28);		/* NOP    */

	return word;
}

/*
 * 0010 .. 1111
 *
 * RESERVED
 */

/*****************************************************************************
 *
 * Compound functions
 *
 *****************************************************************************/

/*
 * GOTO 200
 *
 *  GO TO CODE ORIGIN
 */
void
pic24_goto200(void)
{
	pic24_six(0x040200, pic24_conf.gotonop); /* GOTO 200 */
}

/*
 * READ REGISTER
 */
uint16_t
pic24_readreg(uint16_t regin)
{
	uint32_t reg  = 0x800000 | (regin << 3);
	uint32_t visi = 0x880000 | (pic24_conf.visi << 3);
	uint16_t regout;

	pic24_six(reg,  1);	/* MOV #reg, W0 */
	pic24_six(visi, 1);	/* MOV W0, VISI */

	regout = pic24_regout();

	return regout;
}

/*
 * INITIALISE TBLPAG, THE READ POINTER (W6) AND THE WRITE POINTER (W7) FOR TBLRD INSTRUCTION
 *
 *  AFFECTS
 *   TBLPAG = ADDRESS HIGH
 *   W6 = ADDRESS LOW
 *   W7 = VISI
 */
void
pic24_set_read_pointer(uint32_t addr)
{
	uint32_t high   = 0x200000 | ((addr & 0x00FF0000) >> 12);
	uint32_t tblpag = 0x880000 | (pic24_conf.tblpag   << 3);
	uint32_t low    = 0x200006 | ((addr & 0x0000FFFF) << 4);
	uint32_t visi   = 0x200007 | (pic24_conf.visi     << 4);
#ifdef DEBUG
	printf("%s: PCL=%04X\n", __func__, pic24_readreg(_PCL));
#endif
	pic24_six(high,   0);	/* MOV #<SourceAddress23:16>, W0 */
	pic24_six(tblpag, 0);	/* MOV W0, TPLPAG                */
	pic24_six(low,    0);	/* MOV #<SourceAddress15:0>, W6  */
	pic24_six(visi,   1);	/* MOV #VISI, W7                 */
}

/*
 * INITIALISE TBLPAG AND THE WRITE POINTER (W7) FOR TBLWT INSTRUCTION
 *
 *  AFFECTS
 *   TBLPAG = ADDRESS HIGH
 *   W7 = ADDRESS LOW
 */
void
pic24_set_write_pointer(uint32_t addr)
{
	uint32_t high   = 0x200000 | ((addr & 0x00FF0000) >> 12);
	uint32_t tblpag = 0x880000 | (pic24_conf.tblpag   << 3);
	uint32_t low    = 0x200007 | ((addr & 0x0000FFFF) << 4);
#ifdef DEBUG
	printf("%s: PCL=%04X\n", __func__, pic24_readreg(_PCL));
#endif
	pic24_six(high,   0);	/* MOV #<DestinationAddress23:16>, W0 */
	pic24_six(tblpag, 0);	/* MOV W0, TPLPAG                */
	pic24_six(low,    1);	/* MOV #<DestinationAddress15:0>, W7  */
}

/*
 * TABLE READ 16-BIT WITH POST INCREMENT
 *
 *  REQUIRES
 *   TBLPAG = ADDRESS HIGH
 *   W6 = ADDRESS LOW
 *   W7 = VISI
 *
 *   96 0B BA TBLRDL [W6], [W7]
 *   B6 0B BA TBLRDL [W6++], [W7]
 */
static inline uint16_t
pic24_table_read16_post_increment(void)
{
	uint16_t word;

	/* TABLE READ LOW (WORD) [TBLPAG]:[W6] => [W7] (VISI), INCREMENT W6                    */
	pic24_six(0xBA0BB6, pic24_conf.tblnop);	/* TBLRDL [W6++], [W7]                 */
	word = pic24_regout();				/* Clock out contents of VISI register */

	return word;
}

/*
 * TABLE READ 24-BIT WITH POST INCREMENT
 *
 *  REQUIRES
 *   TBLPAG = ADDRESS HIGH
 *   W6 = ADDRESS LOW
 *   W7 = VISI
 *
 *   96 0B BA TBLRDL [W6], [W7]
 *   B6 0B BA TBLRDL [W6++], [W7]
 *
 *   96 8B BA TBLRDH [W6], [W7]
 *   B6 8B BA TBLRDH [W6++], [W7]
 */
uint32_t
pic24_table_read24_post_increment(void)
{
	uint32_t word;
	uint16_t low, high;

	/* TABLE READ LOW  WORD [TBLPAG]:[W6] => [W7] (VISI)                                   */
	pic24_six(0xBA0B96, pic24_conf.tblnop);	/* TBLRDL [W6], [W7]		       */
	low = pic24_regout();				/* Clock out contents of VISI register */

	/* TABLE READ HIGH WORD [TBLPAG]:[W6++] => [W7] (VISI)                                 */
	pic24_six(0xBA8BB6, pic24_conf.tblnop);	/* TBLRDH [W6++], [W7]                 */
	high = pic24_regout();				/* Clock out contents of VISI register */

	word = ((high << 16) | low) & PIC24_MASK;

	return word;
}

/*
 * TABLE READ 2 x 24-BIT WITH POST INCREMENT
 *
 *  REQUIRES
 *   TBLPAG = ADDRESS HIGH
 *   W6 = ADDRESS LOW
 *   W7 = VISI
 */
void
pic24_table_read48_post_increment(uint32_t *word0, uint32_t *word1)
{
	uint16_t msb;

	pic24_six(0xBA0B96, pic24_conf.tblnop);	/* TBLRDL [W6], [W7]		       */
	*word0 = pic24_regout();			/* Clock out contents of VISI register */

	pic24_six(0xBADBB6, pic24_conf.tblnop);	/* TBLRDH.B [W6++], [W7++]             */
	pic24_six(0xBAD3D6, pic24_conf.tblnop);	/* TBLRDH.B [++W6], [W7--]             */
	msb = pic24_regout();				/* Clock out contents of VISI register */

	pic24_six(0xBA0BB6, pic24_conf.tblnop);	/* TBLRDL [W6++], [W7]		       */
	*word1 = pic24_regout();			/* Clock out contents of VISI register */

	*word0 |= (msb & 0x00FF) << 16;
	*word1 |= (msb & 0xFF00) << 8;
}

/*
 * WAIT FOR PROGRAM/ERASE COMPLETION
 */
void
pic24_nvmcon_write_completion(uint16_t mask, uint16_t word)
{
	struct timeval tv1 = {0}, tv2 = {0}, tv3 = {0};
	uint16_t regout;

	gettimeofday(&tv1, NULL);
	io_program_out(0, 28); /* NOP */
	do {
		gettimeofday(&tv2, NULL);
		timersub(&tv2, &tv1, &tv3);

		regout = pic24_readreg(pic24_conf.nvmcon) & mask;
		pic24_goto200(); /* GOTO 200 */
	}
	while ((regout != word) && (tv3.tv_sec < PIC_TIMEOUT));

	if (tv3.tv_sec >= PIC_TIMEOUT)
		printf("%s: information: program/erase timed out.\n", __func__);
}

/*
 * INITIATE PROGRAM/ERASE THEN DELAY FOR COMPLETION
 *
 * DS70102H-page 70 dsPIC30F4013
 * DS70284C-page 30 dsPIC30F1010
 */
void
pic24_nvmcon_write_external(uint32_t tdly)
{
 	/* NVMCON = 0x760 */
	pic24_six(0x200558, 0);	/* MOV #0x55, W8      */
	pic24_six(0x200AA9, 0);	/* MOV #0xAA, W9      */
	pic24_six(0x883B38, 0);	/* MOV W8, NVMKEY     */
	pic24_six(0x883B39, 0);	/* MOV W9, NVMKEY     */
	pic24_six(0xA8E761, 4);	/* BSET NVMCON, #WR   */
	io_usleep(tdly);
	pic24_six(0xA9E761, 4);	/* BCLR NVMCON, #WR   */
	pic24_goto200();
}

/*
 * INITIATE PROGRAM/ERASE THEN WAIT FOR COMPLETION
 *
 * DS39768D-page 17 PIC24FJ64GA002
 */
static inline void
pic24_nvmcon_write_internal(void)
{
 	/* NVMCON = 0x760 */
	pic24_six(0xA8E761, 2); /* BSET NVMCON, #WR */
	pic24_nvmcon_write_completion(0x8000, 0x0000);
}

/*
 * RESTORE CALIBRATION WORDS AFTER EXEC ERASED
 */
void
pic24_restore_calibration(void)
{
	if (pic24_map[pic24_index].calibaddr == 0)
		return; /* Not supported */
	
	pic24_write_program_init();

	pic_write_panel(PIC_PANEL_BEGIN, PIC_REGIONEXEC, pic24_map[pic24_index].codepanelsize);
	uint32_t address = pic24_map[pic24_index].calibaddr;
	for (uint32_t i = 0; i < pic24_map[pic24_index].ncalib; ++i) {
		pic_write_panel(PIC_PANEL_UPDATE, address >> 1, pic24_conf.calib[i]);
		address += 2;
	}
	pic_write_panel(PIC_PANEL_END, PIC_VOID, PIC_VOID);
}

/*
 * BLANK dsPIC30
 *
 * DS70102H-page 69 dsPIC30F4013
 */
void
pic24_dsPIC30F_erase(uint32_t tdly)
{
 	/* NVMCON = 0x760 */
	pic24_program_verify();

	/* ERASE CONFIG */
	if (pic24_map[pic24_index].deviceid == dsPIC30F5011 ||
		pic24_map[pic24_index].deviceid == dsPIC30F5013) {
		pic24_conf.config[3] = PIC24_CONFIG_PENDING; /* FBS = 0x0000 */
		pic24_conf.config[4] = PIC24_CONFIG_PENDING; /* FSS = 0x0000 */
	}
	pic24_write_config_words();

	/* ERASE UNIT */
	pic24_write_program(pic24_map[pic24_index].fuidaddr, pic24_conf.fuid,
		pic24_map[pic24_index].nfuid);

	/* 407F ERASE CODE, DATA, EXEC & PROTECTION */
	pic24_six(0x2407FA, 0);	/* MOV #0x407F, W10   */
	pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON    */

	/* EXTERNALLY TIME */
	pic24_nvmcon_write_external(tdly);

	pic24_standby();
}

/*
 * BLANK PIC24FJ
 *
 * DS39768D-page 17 PIC24FJ64GA002
 */
void
pic24_PIC24FJ_erase(void)
{
 	/* NVMCON = 0x760 */
	pic24_program_verify();

	/* 404F ERASE CHIP */
	pic24_six(0x2404FA, 0);	/* MOV #0x404F, W10   */
	pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON    */
	pic24_six(0x200000, 0);	/* MOV #<PAGEVAL>, W0 */
	pic24_six(0x880190, 0);	/* MOV W0, TBLPAG     */
	pic24_six(0x200000, 0);	/* MOV #0x0000, W0    */
	pic24_six(0xBB0800, 2);	/* TBLWTL W0, [W0]    */

	pic24_nvmcon_write_internal();

	pic24_standby();
}

/*
 * BLANK dsPIC33FJ/PIC24FJXXMC
 *
 * DS70658C-page 12 dsPIC33FJ06GS101A (P11=240ms, P10=400ns)
 * DS75012B-page 12 PIC24FJ16MC101    (P11=240ms, P10=400ns)
 */
void
pic24_dsPIC33FJ_erase(void)
{
 	/* NVMCON = 0x760 */
	pic24_program_verify();

	/* 404F ERASE CHIP */
	pic24_six(0x2404FA, 0);	/* MOV #0x404F, W10     */
	pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON      */
	pic24_six(0x200000, 0);	/* MOV #<PAGEVAL>, W0   */
	pic24_six(0x880190, 0);	/* MOV W0, TBLPAG       */
	pic24_six(0xA8E761, 4);	/* BSET NVMCON, #WR     */
	io_usleep(240001);		/* P11=240ms, P10=400ns */

	pic24_nvmcon_write_completion(0x8000, 0x0000);

	pic24_standby();
}

/*
 * BLANK PIC24F KA/KM/KL
 *
 * DS39919C-page 11
 */
#undef CALIBKA
void
pic24_PIC24FKA_erase(void)
{
 	/* NVMCON = 0x760 */
	pic24_program_verify();
#ifdef CALIBKA
	/* ERASE EXEC & CALIBRATION */
	pic24_six(0x2405AA, 0);	/* MOV #0x405A, W10   */
	pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON    */
	pic24_six(0x200800, 0);	/* MOV #<PAGEVAL>, W0 */
	pic24_six(0x880190, 0);	/* MOV W0, TBLPAG     */
	pic24_six(0x200000, 0);	/* MOV #0x0000, W0    */
	pic24_six(0xBB0800, 2);	/* TBLWTL W0, [W0]    */

	pic24_nvmcon_write_internal();
#endif
	/* 4064 ERASE CODE, DATA, PROTECTION & CONFIG */
	pic24_six(0x24064A, 0);	/* MOV #0x4064, W10   */
	pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON    */
	pic24_six(0x200000, 0);	/* MOV #<PAGEVAL>, W0 */
	pic24_six(0x880190, 0);	/* MOV W0, TBLPAG     */
	pic24_six(0x200000, 0);	/* MOV #0x0000, W0    */
	pic24_six(0xBB0800, 2);	/* TBLWTL W0, [W0]    */

	pic24_nvmcon_write_internal();
#ifdef CALIBKA
	/* RESTORE CALIBRATION WORDS */
	pic24_restore_calibration();
#endif
	pic24_standby();
}

/*
 * BLANK dsPIC33F/PIC24H
 */
void
pic24_dsPIC33F_PIC24H_erase(void)
{
 	/* NVMCON = 0x760 */
	pic24_program_verify();

	/* ERASE CONFIG */
	pic24_write_config_words();

	/* ERASE FUID */
	pic24_write_fuid_words();

	/* 404F ERASE CHIP */
	pic24_six(0x2404FA, 0);	/* MOV #0x404F, W10     */
	pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON      */
	pic24_six(0x200000, 0);	/* MOV #<PAGEVAL>, W0   */
	pic24_six(0x880190, 0);	/* MOV W0, TBLPAG       */
	pic24_six(0xA8E761, 4);	/* BSET NVMCON, #WR     */
	io_usleep(330001);		/* P11=330ms, P10=400ns */

	pic24_nvmcon_write_completion(0x8000, 0x0000);

	/* RESTORE CALIBRATION WORDS */
	pic24_restore_calibration();

	pic24_standby();
}

/*
 * BLANK dsPIC33E/PIC24E
 */
void
pic24_dsPIC33E_PIC24E_erase(void)
{
 	/* NVMCON = 0x728 */
	pic24_program_verify();

	/* 400F ERASE CODE, EXEC & FUID */
	pic24_six(0x2400FA, 1);	/* MOV #0x400F, W10   */
	pic24_six(0x88394A, 2);	/* MOV W10, NVMCON    */
	pic24_six(0x200551, 0);	/* MOV #0x55, W1      */
	pic24_six(0x883971, 0);	/* MOV W1, NVMKEY     */
	pic24_six(0x200AA1, 0);	/* MOV #0xAA, W1      */
	pic24_six(0x883971, 0);	/* MOV W1, NVMKEY     */
	pic24_six(0xA8E729, 3);	/* BSET NVMCON, #WR   */
	io_usleep(21001);		/* P11=21ms P10=400ns */
#if 1
	pic24_nvmcon_write_completion(0xFFFF, 0x400F);
#endif
	pic24_standby();
}

/*
 * BLANK DEVICE
 *
 * DISABLE PROTECTION AND BULK ERASE
 */
void
pic24_bulk_erase(void)
{
	/* RESET CONFIG & FUID FOR ERASURE */
	memset(pic24_conf.fuid, -1, sizeof(uint32_t) * PIC24_FUID_MAX);
	memset(pic24_conf.config, -1, sizeof(uint32_t) * PIC24_CONFIG_MAX);

	switch (pic24_map[pic24_index].datasheet) {
	case DS70102H: /* dsPIC30F      */
	case DS70284B: /* dsPIC30F SMPS */
		/* DS70284C-page 28 dsPIC30F1010 EXTERNALLY TIMED(200ms) */
		pic24_dsPIC30F_erase(200000);
		break;
	case DS39786D:	  /* PIC24FJ           */
	case DS39934B:	  /* PIC24FJXXGA1/GB0  */
	case DS30000510E: /* PIC24FJXXXGA2/GB2 */
		pic24_PIC24FJ_erase();
		break;
	case DS70659C: /* dsPIC33FJ         */
	case DS75012B: /* PIC24FJXXMC       */
		pic24_dsPIC33FJ_erase();
		break;
	case DS39919C: /* PIC24F KA         */
	case DS30625D: /* PIC24F KM/KL      */
		pic24_PIC24FKA_erase();
		break;
	case DS70152H: /* dsPIC33F/PIC24H   */
		pic24_dsPIC33F_PIC24H_erase();
		break;
	case DS70663D: /* dsPIC33EP/PIC24EP */
		pic24_dsPIC33E_PIC24E_erase();
		break;
	default:printf("%s: information: unimplemented\n", __func__);
		break;
	}
}

/*****************************************************************************
 *
 * Read block data
 *
 *****************************************************************************/

/*
 * GET DEVICE INDEX
 */
static uint32_t
pic24_get_dev(void)
{
	uint32_t dev = 0;

	/* Device id/rev */
	pic24_set_read_pointer(PIC24_DEVID);
	pic24_conf.deviceid = pic24_table_read16_post_increment();
	pic24_conf.revision = pic24_table_read16_post_increment();

	while (pic24_map[dev].deviceid) {
		if (pic24_map[dev].deviceid == pic24_conf.deviceid)
			break;
		++dev;
	}
	return dev;
}

/*
 * GET CONFIGURATION
 */
int
pic24_read_config_memory(void)
{
	uint32_t dev;

	/* NULL device */
	pic24_index = PIC24_SIZE;

	/* Reset configuraton */
	memset(&pic24_conf, 0, sizeof(pic24_conf));

	/* Device selected by user */
	if (p.devicename[0]) {
		for (dev = 0; pic24_map[dev].deviceid; ++dev) {
			if (strcasecmp(pic24_map[dev].devicename, p.devicename) == 0) {
				/* Device recognised */
				pic24_index = dev;
				break;
			}
		}
		if (pic24_map[dev].deviceid == 0) {
			printf("%s: information: unknown device: [%s]\n", __func__, p.devicename);
			return -1;
		}
	}

	/* Device id/rev */
	switch (pic24_map[pic24_index].datasheet) {
	default:
		pic24_conf.tblpag  = 0x0032;
		pic24_conf.nvmcon  = 0x0760;
		pic24_conf.visi    = 0x0784;
		pic24_conf.tblnop  = 2 + 1 - 1;	/* TBLRD: 2 CYCLES + 1 STALL */
		pic24_conf.gotonop = 2 + 0 - 1;	/* GOTO:  2 CYCLES + 0 STALL */
		pic24_program_verify();
		pic24_index = pic24_get_dev();
#if 0
		if (!pic24_map[pic24_index].deviceid) {
			pic24_standby();
			pic24_conf.tblpag  = 0x0054;
			pic24_program_verify();
			pic24_index = pic24_get_dev();
		}
#endif
		break;
	case DS70663D:
		pic24_conf.tblpag  = 0x0054;
		pic24_conf.nvmcon  = 0x0728;
		pic24_conf.visi    = 0x0F88;
		pic24_conf.tblnop  = 5 + 1 - 1;	/* TBLRD: 5 CYCLES + 1 STALL */
		pic24_conf.gotonop = 4 + 0 - 1;	/* GOTO:  4 CYCLES + 0 STALL */
		pic24_program_verify();
		pic24_index = pic24_get_dev();
		break;
	case DS30000510E:
		pic24_conf.tblpag  = 0x0054;
		pic24_conf.nvmcon  = 0x0760;
		pic24_conf.visi    = 0x0784;
		pic24_conf.tblnop  = 2 + 1 - 1; /* TBLRD: 2 CYCLES + 1 STALL */
		pic24_conf.gotonop = 2 + 0 - 1; /* GOTO:  2 CYCLES + 0 STALL */
		pic24_program_verify();
		pic24_index = pic24_get_dev();
		break;
	}
	if (!pic24_map[pic24_index].deviceid) {
		if (pic24_conf.deviceid == 0x0000 || pic24_conf.deviceid == 0xFFFF) {
			printf("%s: information: %s.\n",
				__func__, io_fault(pic24_conf.deviceid));
		} else {
			printf("%s: information: device unknown: [%06X] [%06X]\n",
				__func__, pic24_conf.deviceid, pic24_conf.revision);
		}
		pic24_standby();
		return -1;
	}
#if 0
	/* Device family */
	dev = 0;
	while (pic24_tab[dev].datasheet) {
		if (pic24_tab[dev].datasheet == pic24_map[pic24_index].datasheet) {
			pic_pe_lookup(pic24_conf.pepath, pic24_tab[dev].filename);
			break;
		}
		++dev;
	}
#endif
	/* App-id */
	if ((pic24_map[pic24_index].datasheet == DS70102H) ||	/* dsPIC30F      */
		(pic24_map[pic24_index].datasheet == DS70284B))	/* dsPIC30F SMPS */
		pic24_set_read_pointer(dsPIC30F_APPID_ADDR);
	else if (pic24_map[pic24_index].datasheet == DS70663D)
		pic24_set_read_pointer(dsPIC33E_APPID_ADDR);
	else
		pic24_set_read_pointer(PIC24_APPID_ADDR);
	pic24_conf.appid = pic24_table_read24_post_increment();

	/* Config */
	pic24_set_read_pointer(pic24_map[pic24_index].configaddr);
	for (uint32_t i = 0; i < pic24_map[pic24_index].nconfig; ++i)
		pic24_conf.config[i] = pic24_table_read16_post_increment();

	/* Fuid */
	if (pic24_map[pic24_index].fuidaddr) {
		pic24_set_read_pointer(pic24_map[pic24_index].fuidaddr);
		for (uint32_t i = 0; i < pic24_map[pic24_index].nfuid; ++i)
			pic24_conf.fuid[i] = pic24_table_read24_post_increment();
	}

	/* Calibration */
	if (pic24_map[pic24_index].calibaddr) {
		pic24_set_read_pointer(pic24_map[pic24_index].calibaddr);
		for (uint32_t i = 0; i < pic24_map[pic24_index].ncalib; ++i)
			pic24_conf.calib[i] = pic24_table_read24_post_increment();
	}

	pic24_standby();

	return 0;
}

/*
 * GET PROGRAM FLASH SIZE
 *
 *  RETURN SIZE IN WORDS
 */
uint32_t
pic24_get_program_size(uint32_t *addr)
{
	*addr = 0;

	return pic24_map[pic24_index].flash;
}

/*
 * GET DATA EEPROM/FLASH SIZE
 *
 *  RETURN SIZE IN BYTES
 */
uint32_t
pic24_get_data_size(uint32_t *addr)
{
	if (pic24_map[pic24_index].eeprom) {
		*addr = PIC24_EXEC_LOW - pic24_map[pic24_index].eeprom;
	} else {
		*addr = 0;
	}
	return pic24_map[pic24_index].eeprom;
}

/*
 * GET EXECUTIVE SIZE
 *
 *  RETURN SIZE IN WORDS
 */
uint32_t
pic24_get_executive_size(uint32_t *addr)
{
	uint32_t size = 0;

	*addr = PIC24_EXEC_LOW;

	if ((pic24_map[pic24_index].datasheet == DS70102H) ||	/* dsPIC30F      */
		(pic24_map[pic24_index].datasheet == DS70284B))	/* dsPIC30F SMPS */
		size = dsPIC30F_EXEC_HIGH - PIC24_EXEC_LOW;
	else if (pic24_map[pic24_index].datasheet == DS70663D)	/* dsPIC33EP/PIC24EP */
		size = dsPIC33E_EXEC_HIGH - PIC24_EXEC_LOW;
	else
		size = PIC24_EXEC_HIGH - PIC24_EXEC_LOW;

	return (size >> 1);
}

/*
 * READ PROGRAM FLASH MEMORY BLOCK ADDR .. ADDR + SIZE
 *
 *  RETURN ADDR
 */
#define GOTO200 (32)
uint32_t
pic24_read_program_memory_block(uint32_t *data, uint32_t addr, uint32_t size)
{
	if (size & 1) {
		printf("%s: fatal error: block size (%u) uneven\n", __func__, size);
		io_exit(EX_SOFTWARE); /* Panic */
	}

	pic24_program_verify();

	pic24_set_read_pointer(addr);
	uint32_t pc = 0;
	for (uint32_t i = 0; i < size;) {
		if ((pc++ % GOTO200) == 0)
			pic24_goto200();
		uint32_t word0, word1;
		pic24_table_read48_post_increment(&word0, &word1);
		data[i++] = (uint32_t)word0;
		data[i++] = (uint32_t)word1;
#ifdef DEBUG
		char d[STRLEN];
		snprintf(d, STRLEN, "%s() addr=%06X size=%d", __func__, addr, size);
		printf("%s: PCL=%04X\n", d, pic24_readreg(_PCL));
#endif
		addr += 4;
		if ((addr % 0x0010000) == 0)
			pic24_set_read_pointer(addr);
	}

	pic24_standby();

	return addr;
}

/*
 * READ DATA EEPROM/FLASH MEMORY BLOCK ADDR .. ADDR + SIZE
 *
 *  RETURN ADDR
 */
uint32_t
pic24_read_data_memory_block(uint16_t *data, uint32_t addr, uint16_t size)
{
	pic24_program_verify();

	pic24_set_read_pointer(addr);
	uint32_t pc = 0;
	for (uint32_t i = 0; i < size;) {
		if ((pc++ % GOTO200) == 0)
			pic24_goto200();
		data[i++] = pic24_table_read16_post_increment();
#ifdef DEBUG
		char d[STRLEN];
		snprintf(d, STRLEN, "%s() addr=%06X size=%d", __func__, addr, size);
		printf("%s: PCL=%04X\n", d, pic24_readreg(_PCL));
#endif
	}

	pic24_standby();

	return addr;
}

/*****************************************************************************
 *
 * Program Code
 *
 *****************************************************************************/

/*
 * WRITE PROGRAM INIT
 *
 *  SETUP FOR PROGRAM OR DATA WRITING
 */
void
pic24_write_program_init(void)
{
	/* RESET CONFIG & FUID FOR PROGRAMMING */
	memset(pic24_conf.fuid, 0, sizeof(uint32_t) * PIC24_FUID_MAX);
	memset(pic24_conf.config, 0, sizeof(uint32_t) * PIC24_CONFIG_MAX);

	switch (pic24_map[pic24_index].datasheet) {
	case DS39786D:    /* PIC24FJ           */
	case DS70152H:    /* dsPIC33F/PIC24H   */
	case DS39934B:    /* PIC24FJXXGA1/GB0  */
	case DS30000510E: /* PIC24FJXXXGA2/GB2 */
 		/* NVMCON = 0x760 */
		pic24_six(0x24001A, 0); 	/* MOV #0x4001, W10     */
		pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON      */
		break;
	case DS70659C: /* dsPIC33FJ    */
	case DS75012B: /* PIC24FJXXMC  */
 		/* NVMCON = 0x760 */
		pic24_six(0x24003A, 0); 	/* MOV #0x4003, W10     */
		pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON      */
		break;
	case DS39919C: /* PIC24F KA    */
	case DS30625D: /* PIC24F KM/KL */
 		/* NVMCON = 0x760 */
		pic24_six(0x24004A, 0); 	/* MOV #0x4004, W10     */
		pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON      */
		break;
	case DS70663D: /* dsPIC33EP/PIC24EP */
		pic24_six(0x200FAC, 0);	/* MOV #0xFA, W12       */
		pic24_six(0x8802AC, 0);	/* MOV W12, TBLPAG      */
	default:break;
	}
}

/*
 * WRITE 24-BIT PROGRAM BUFFER TO 24-BIT PROGRAM FLASH
 */
void
pic24_write_program(uint32_t address, uint32_t *buffer, uint32_t buffer_size)
{
#if 0
	printf("%s() address=%06X buffer_size=%d\n", __func__, address, buffer_size);
	pic24_dumphexcode(address, buffer_size, buffer);
#else
	switch (pic24_map[pic24_index].datasheet) {
	case DS70102H: /* dsPIC30F      */
	case DS70284B: /* dsPIC30F SMPS */
 		/* NVMCON = 0x760 */
		pic24_six(0x24001A, 0); 	/* MOV #0x4001, W10  */
		pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON   */
	default:break;
	}
	pic24_set_write_pointer(address);
	for (uint32_t i = 0; i < buffer_size; i += 4) {
		uint16_t lsw0 = buffer[i + 0];
		uint16_t lsw1 = buffer[i + 1];
		uint16_t lsw2 = buffer[i + 2];
		uint16_t lsw3 = buffer[i + 3];
		uint8_t  msb0 = buffer[i + 0] >> 16;
		uint8_t  msb1 = buffer[i + 1] >> 16;
		uint8_t  msb2 = buffer[i + 2] >> 16;
		uint8_t  msb3 = buffer[i + 3] >> 16;

		uint32_t w0 = 0x200000 | (lsw0 << 4);
		uint32_t w1 = 0x200001 | (msb1 << 12) | (msb0 << 4);
		uint32_t w2 = 0x200002 | (lsw1 << 4);
		uint32_t w3 = 0x200003 | (lsw2 << 4);
		uint32_t w4 = 0x200004 | (msb3 << 12) | (msb2 << 4);
		uint32_t w5 = 0x200005 | (lsw3 << 4);

		/* LOAD W0:W5 WITH 4 INSTRUCTIONS */
		pic24_six(w0, 0);	/* MOV #<LSW0>, W0      */
		pic24_six(w1, 0);	/* MOV #<MSB1:MSB0>, W1 */
		pic24_six(w2, 0);	/* MOV #<LSW1>, W2      */
		pic24_six(w3, 0); 	/* MOV #<LSW2>, W3      */
		pic24_six(w4, 0); 	/* MOV #<MSB3:MSB2>, W4 */
		pic24_six(w5, 0);	/* MOV #<LSW3>, W5      */

		/* SET THE READ POINTER AND LOAD LATCHES */
		pic24_six(0xEB0300, 1);/* CLR W6                  */
		pic24_six(0xBB0BB6, 2);/* TBLWTL   [W6++], [W7]   */
		pic24_six(0xBBDBB6, 2);/* TBLWTH.B [W6++], [W7++] */
		pic24_six(0xBBEBB6, 2);/* TBLWTH.B [W6++], [++W7] */
		pic24_six(0xBB1BB6, 2);/* TBLWTL   [W6++], [W7++] */
		pic24_six(0xBB0BB6, 2);/* TBLWTL   [W6++], [W7]   */
		pic24_six(0xBBDBB6, 2);/* TBLWTH.B [W6++], [W7++] */
		pic24_six(0xBBEBB6, 2);/* TBLWTH.B [W6++], [++W7] */
		pic24_six(0xBB1BB6, 2);/* TBLWTL   [W6++], [W7++] */
	}	

	switch (pic24_map[pic24_index].datasheet) {
	case DS70102H: /* dsPIC30F      */
	case DS70284B: /* dsPIC30F SMPS */
		/* DS70102H-page 90 dsPIC30F4013 TPROG P12(2ms MAX) */
		/* DS70284B-page 44 dsPIC30F1010 TPROG P18(4ms MAX) */
		pic24_nvmcon_write_external(4000);
		break;
	default:pic24_nvmcon_write_internal();
		break;
	}
#endif
}

/*
 * WRITE 16-BIT DATA BUFFER TO 16-BIT DATA EEPROM
 *
 *  TBLPAG = 0x7F
 */
void
pic24_write_data(uint32_t address, uint32_t *buffer, uint32_t buffer_size)
{
	switch (pic24_map[pic24_index].datasheet) {
	case DS70102H: /* dsPIC30F */
 		/* NVMCON = 0x760 */
		pic24_six(0x24005A, 0); 	/* MOV #0x4005, W10  */
		pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON   */
	default:break;
	}
	pic24_set_write_pointer(address);
	for (uint32_t i = 0; i < buffer_size; i += 4) {
		uint32_t w0 = 0x200000 | ((0xFFFF & buffer[i + 0]) << 4);
		uint32_t w1 = 0x200001 | ((0xFFFF & buffer[i + 1]) << 4);
		uint32_t w2 = 0x200002 | ((0xFFFF & buffer[i + 2]) << 4);
		uint32_t w3 = 0x200003 | ((0xFFFF & buffer[i + 3]) << 4);

		/* LOAD W0:W3 WITH 4 DATA WORDS */
		pic24_six(w0, 0);	/* MOV #<WORD0>, W0 */
		pic24_six(w1, 0);	/* MOV #<WORD1>, W1 */
		pic24_six(w2, 0);	/* MOV #<WORD2>, W2 */
		pic24_six(w3, 0); 	/* MOV #<WORD3>, W3 */

		/* SET THE READ POINTER AND LOAD LATCHES */
		pic24_six(0xEB0300, 1);/* CLR W6                  */
		pic24_six(0xBB1BB6, 2);/* TBLWTL   [W6++], [W7++] */
		pic24_six(0xBB1BB6, 2);/* TBLWTL   [W6++], [W7++] */
		pic24_six(0xBB1BB6, 2);/* TBLWTL   [W6++], [W7++] */
		pic24_six(0xBB1BB6, 2);/* TBLWTL   [W6++], [W7++] */
	}	

	switch (pic24_map[pic24_index].datasheet) {
	case DS70102H: /* dsPIC30F */
		/* DS70102H-page 90 dsPIC30F4013 TPROG P12(2ms MAX) */
		pic24_nvmcon_write_external(2000);
		break;
	default:pic24_nvmcon_write_internal();
		break;
	}
}

/*
 * WRITE 24-BIT PROGRAM WORD TO 24-BIT PROGRAM FLASH
 *
 *  TBLPAG = 0x00
 */
void
pic24_write_program_word24(uint32_t address, uint32_t word)
{
	uint32_t w2 = 0x200002 | ((0x0000FFFF & address) << 4);
	uint32_t w5 = 0x200005 | ((0x0000FFFF & word)    << 4);
	uint32_t w6 = 0x200006 | ((0x00FF0000 & word)    >> 12);

	pic24_six(w2, 0);		/* MOV #<DestinationAddress15:0>, W2 */
	pic24_six(w5, 0);		/* MOV #<LOW_WORD>, W5               */
	pic24_six(w6, 1);		/* MOV #<HIGH_BYTE>, W6              */
	pic24_six(0xBB0905, 2);	/* TBLWTL W5, [W2]                   */
	pic24_six(0xBB9906, 3);	/* TBLWTH.B W6, [W2++]               */
	pic24_nvmcon_write_internal();
}

/*
 * WRITE 24-BIT x 2 PROGRAM WORDS TO 24-BIT PROGRAM FLASH
 *
 *  TBLPAG = 0xFA
 */
void
pic24_write_program_word48(uint32_t address, uint32_t word0, uint32_t word1)
{
 	/* NVMCON = 0x728 */
	uint16_t lsw0 = word0;
	uint16_t lsw1 = word1;
	uint8_t  msb0 = word0 >> 16;
	uint8_t  msb1 = word1 >> 16;

	uint32_t w0 = 0x200000 | (lsw0 << 4);
	uint32_t w1 = 0x200001 | (msb1 << 12) | (msb0 << 4);
	uint32_t w2 = 0x200002 | (lsw1 << 4);

	/* LOAD W0:W2 WITH 2 INSTRUCTIONS */
	pic24_six(w0, 0);	/* MOV #<LSW0>, W0      */
	pic24_six(w1, 0);	/* MOV #<MSB1:MSB0>, W1 */
	pic24_six(w2, 0);	/* MOV #<LSW1>, W2      */

	/* SET THE READ POINTER (W6) AND WRITE POINTER (W7) AND LOAD THE WRITE LATCHES */
	pic24_six(0xEB0300, 1);/* CLR W6                  */
	pic24_six(0xEB0380, 1);/* CLR W7                  */
	pic24_six(0xBB0BB6, 2);/* TBLWTL   [W6++], [W7]   */
	pic24_six(0xBBDBB6, 2);/* TBLWTH.B [W6++], [W7++] */
	pic24_six(0xBBEBB6, 2);/* TBLWTH.B [W6++], [++W7] */
	pic24_six(0xBB1BB6, 2);/* TBLWTL   [W6++], [W7++] */

	uint32_t w3 = 0x200003 | ((address & 0x00FFFF) << 4);
	uint32_t w4 = 0x200004 | ((address & 0xFF0000) >> 12);

	/* SET THE NVMADRU/NVMADR REGISTER-PAIR TO POINT TO THE CORRECT ADDRESS */
	pic24_six(w3, 0);      /* MOV #DestinationAddress<15:0>, W3  */
	pic24_six(w4, 0);	  /* MOV #DestinationAddress<23:16>, W4 */
	pic24_six(0x883953, 0);/* MOV W3, NVMADR  */
	pic24_six(0x883964, 0);/* MOV W4, NVMADRU */

	/* SET THE NVMCON TO PROGRAM TWO INSTRUCTION WORDS */
	pic24_six(0x24001A, 1);/* MOV 0x4001, W10 */
	pic24_six(0x88394A, 2);/* MOV W10, NVMCON */

	/* INITIATE THE WRITE CYCLE */
	pic24_six(0x200551, 0);/* MOV #0x55, W1     */
	pic24_six(0x883971, 0);/* MOV W1, NVMKEY    */
	pic24_six(0x200AA1, 0);/* MOV #0xAA, W1     */
	pic24_six(0x883971, 0);/* MOV W1, NVMKEY    */
	pic24_six(0xA8E729, 3);/* BSET NVMCON, #WR  */

	/* DS700000657H TWW(53.8us) or TWW(54.4us)     */
	io_usleep(55);	  /* P13=TWW P10=400ns */

	pic24_nvmcon_write_completion(0xFFFF, 0x4001);
}

/*
 * WRITE 16-BIT DATA WORD TO 16-BIT DATA EEPROM
 *
 *  TBLPAG = 0x7F
 */
void
pic24_write_data_word16(uint32_t address, uint32_t word)
{
	uint32_t w2 = 0x200002 | ((0x0000FFFF & address) << 4);
	uint32_t w5 = 0x200005 | ((0x0000FFFF & word)    << 4);

	pic24_six(w2, 0);		/* MOV #<DestinationAddress15:0>, W2 */
	pic24_six(w5, 0);		/* MOV #<DATA_WORD_VALUE>, W5        */
	pic24_six(0xBB0905, 2);	/* TBLWTL W5, [W2]                   */

	pic24_nvmcon_write_internal();
}

/*
 * WRITE PANEL TO 24-BIT PROGRAM FLASH OR 16-BIT DATA EEPROM
 */
void
pic24_write_panel(uint32_t region, uint32_t address, uint32_t *panel, uint32_t panel_size)
{
	switch (region) {
	case PIC_REGIONCODE:
	case PIC_REGIONEXEC:
		if (panel_size == 1) {		/* dsPIC33FJ/PIC24FJXXMC WORD WRITING */
			pic24_write_program_word24(address << 1, panel[0]);
		} else if (panel_size == 2) {	/* dsPIC33E/PIC24E DWORD WRITING */
			pic24_write_program_word48(address << 1, panel[0], panel[1]);
		} else {			/* PANEL WRITING */
			pic24_write_program(address << 1, panel, panel_size);
		}
		break;
	case PIC_REGIONDATA:
		if (panel_size == 1) {		/* PIC24F KA KM/KL WORD WRITING */
			pic24_write_data_word16(address << 1, panel[0]);
		} else {			/* PANEL WRITING */
			pic24_write_data(address << 1, panel, panel_size);
		}
		break;
	default:printf("%s: warning: region unsupported [%d]\n", __func__, region);
		break;
	}
}

/*
 * CONFIG INIT
 *
 *  SETUP FOR CONFIG OR FUID WRITING IN THE CONFIG SPACE
 */
void
pic24_write_config_init1(void)
{
	switch (pic24_map[pic24_index].datasheet) {
	case DS39919C:
	case DS30625D:
		/* PIC24F KA      */
		/* PIC24F KM/KL   */
		/* NVMCON = 0x760 */
		pic24_six(0x24004A, 0); 	/* MOV #0x4004, W10    */
		pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON     */
		break;
	case DS70152H:
		/* dsPIC33F/PIC24H */
		/* NVMCON = 0x760  */
		pic24_six(0x24000A, 0); 	/* MOV #0x4000, W10    */
		pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON     */
	default:break;
	}
}

void
pic24_write_config_init2(void)
{
	switch (pic24_map[pic24_index].datasheet) {
	case DS70102H:
	case DS70284B:
		/* dsPIC30F       */
		/* dsPIC30F SMPS  */
		/* NVMCON = 0x760 */
		pic24_six(0x24008A, 0);	/* MOV #0x4008, W10    */
		pic24_six(0x883B0A, 0);	/* MOV W10, NVMCON     */
	default:break;
	}
}

void
pic24_write_config_word(uint32_t address, uint16_t word)
{
	uint32_t w6 = 0x200006 | (word << 4);

	/* INITIALISE TBLPAG AND THE WRITE POINTER (W7) FOR TBLWT INSTRUCTION */
	pic24_set_write_pointer(address);	/* TBLPAG=0xF8 W7=<15:0> */

	/* LOAD THE CONFIGURATION DATA REGISTER TO W6 */
	pic24_six(w6, 1);			/* MOV #<VALUE>, W6      */

	/* WRITE THE CONFIGURATION REGISTER DATA TO THE WRITE LATCH AND INC. WRITE POINTER */
	pic24_six(0xBB1B86, 2);		/* TBLWTL W6, [W7++]     */

	switch (pic24_map[pic24_index].datasheet) {
	case DS70102H: /* dsPIC30F      */
	case DS70284B: /* dsPIC30F SMPS */
		/* DS70102H-page 90 dsPIC30F4013 TPROG P12(2ms MAX) */
		/* DS70284B-page 44 dsPIC30F1010 TPROG P18(4ms MAX) */
		/* UNLOCK NVMCON AND WRITE */
		pic24_nvmcon_write_external(4000);
		break;
	default:/* WRITE */
		pic24_nvmcon_write_internal();
		break;
	}
}

/*
 * WRITE CONFIG WORDS IN THE CONFIG SPACE
 */
uint32_t
pic24_write_config_words(void)
{
	if (pic24_map[pic24_index].configaddr != PIC24_CONFIG_ADDR)
		return 0; /* Not supported here */

	pic24_write_config_init1();
	uint32_t n = 0;
	for (uint32_t i = 0; i < pic24_map[pic24_index].nconfig; ++i) {
		if (pic24_conf.config[i] & PIC24_CONFIG_PENDING) {
			uint32_t address = pic24_map[pic24_index].configaddr + 2 * i;
			pic24_write_config_init2();
			pic24_write_config_word(address, pic24_conf.config[i]);
			n++;
		}
	}

	return n;
}

/*
 * WRITE FUID WORDS IN THE CONFIG SPACE
 */
uint32_t
pic24_write_fuid_words(void)
{
	if (pic24_map[pic24_index].fuidaddr < PIC24_CONFIG_ADDR)
		return 0; /* Not supported here */

	pic24_write_config_init1();
	uint32_t n = 0;
	for (uint32_t i = 0; i < pic24_map[pic24_index].nfuid; ++i) {
		if (pic24_conf.fuid[i] & PIC24_CONFIG_PENDING) {
			uint32_t address = pic24_map[pic24_index].fuidaddr + 2 * i;
			pic24_write_config_init2();
			pic24_write_config_word(address, pic24_conf.fuid[i]);
			n++;
		}
	}

	return n;
}

/*
 * WRITE CONFIGURATION & FUID IN THE CONFIG SPACE
 */
uint32_t
pic24_write_config(void)
{
	if ((pic24_map[pic24_index].configaddr >= PIC24_CONFIG_ADDR) ||
		(pic24_map[pic24_index].fuidaddr >= PIC24_CONFIG_ADDR)) {
		uint32_t n = 0;

		pic24_program_verify();

		if (pic24_map[pic24_index].fuidaddr)
			n += pic24_write_fuid_words();

		if (pic24_map[pic24_index].configaddr)
			n += pic24_write_config_words();

		pic24_standby();
	
		return n;
	}
	return 0;
}

/*****************************************************************************
 *
 * Programming
 *
 *****************************************************************************/

/*
 * DETERMINE MEMORY REGION: CODE, DATA, CONFIG, EXEC, OR ID
 *
 *  RETURN PIC_REGIONCODE:
 *	000000 .. FLASH - 2
 *
 *  RETURN PIC_REGIONDATA:
 *	7FFXXX .. 7FFFFE
 *
 *  RETURN PIC_REGIONCONFIG:
 *	F80000 .. F8000E
 *
 *  RETURN PIC_REGIONEXEC:
 *	800000 .. 8005BE
 *
 *  RETURN PIC_REGIONID:
 *	8005C0 .. 8005FE
 */
uint32_t
pic24_getregion(uint32_t address)
{
	/* CODE */
	uint32_t code_high = (pic24_map[pic24_index].flash << 1) - 2;

	if (address <= code_high) {
		return PIC_REGIONCODE;
	}
	/* EEPROM */
	if (pic24_map[pic24_index].eeprom) {
		uint32_t data_low = PIC24_EXEC_LOW - pic24_map[pic24_index].eeprom;
		uint32_t data_high = PIC24_EXEC_LOW - 2;

		if (address >= data_low && address <= data_high) {
			return PIC_REGIONDATA;
		}
	}
	/* EXEC */
	if ((pic24_map[pic24_index].datasheet == DS70102H) ||		/* dsPIC30F      */
		(pic24_map[pic24_index].datasheet == DS70102H)) {	/* dsPIC30F SMPS */
		if (address >= PIC24_EXEC_LOW && address <= dsPIC30F_EXEC_HIGH) {
			return PIC_REGIONEXEC;
		}
	} else if (pic24_map[pic24_index].datasheet == DS70663D) {	/* dsPIC33EP/PIC24EP */
		if (address >= PIC24_EXEC_LOW && address <= dsPIC33E_EXEC_HIGH) {
			return PIC_REGIONEXEC;
		}
	} else if (address >= PIC24_EXEC_LOW && address <= PIC24_EXEC_HIGH) {
		return PIC_REGIONEXEC;
	}
	/* FUID */
	if (pic24_map[pic24_index].fuidaddr) {
		uint32_t fuid_high = pic24_map[pic24_index].fuidaddr + 2 * pic24_map[pic24_index].nfuid - 2;

		if (address >= pic24_map[pic24_index].fuidaddr && address <= fuid_high) {
			return PIC_REGIONID;
		}
	}
	/* CONFIG */
	if (pic24_map[pic24_index].configaddr == PIC24_CONFIG_ADDR) {
		uint32_t config_high = PIC24_CONFIG_ADDR + 2 * pic24_map[pic24_index].nconfig - 2;

		if (address >= PIC24_CONFIG_ADDR && address <= config_high) {
			return PIC_REGIONCONFIG;
		}
	}
	if (p.f)
		fprintf(p.f, "%s: warning: address unsupported [%06X]\n", __func__, address);
	return PIC_REGIONNOTSUP;
}

/*
 * INIT REGION FOR WRITING (CONFIG DELAYED)
 *
 *  RETURN REGION IF WRITING SUPPORTED
 */
static inline uint32_t
pic24_init_writeregion(uint32_t region)
{
	switch (region) {
	case PIC_REGIONCODE:
	case PIC_REGIONEXEC:
		if (pic24_map[pic24_index].codepanelsize == 1) { /* dsPIC33FJ WORD WRITING */
			/* TBLPAG = 0x00 */
			pic24_six(0x200001, 1);/* MOV #0x00, W1  */
			pic24_six(0x880191, 0);/* MOV W1, TBLPAG */
		}
		pic_write_panel(PIC_PANEL_BEGIN, PIC_REGIONCODE, pic24_map[pic24_index].codepanelsize);
		return region;
	case PIC_REGIONDATA:
		if (pic24_map[pic24_index].datapanelsize == 1) { /* PIC24F KM/KL WORD WRITING */
			/* TBLPAG = 0x7F */
			pic24_six(0x2007F1, 1); /* MOV #0x7F, W1  */
			pic24_six(0x880191, 0); /* MOV W1, TBLPAG */
		}
		pic_write_panel(PIC_PANEL_BEGIN, PIC_REGIONDATA, pic24_map[pic24_index].datapanelsize);
	case PIC_REGIONCONFIG:
	case PIC_REGIONID:
		return region;
	}
	if (p.f)
		fprintf(p.f, "%s: warning: region unsupported [%d]\n", __func__, region);
	return PIC_REGIONNOTSUP;
}

/*
 * WRITE REGION (CACHE CONFIG & FUID WORDS)
 */
static inline void
pic24_writeregion(uint32_t address, uint32_t region, uint32_t data)
{
	switch (region) {
	case PIC_REGIONCODE:
	case PIC_REGIONDATA:
	case PIC_REGIONEXEC:
		pic_write_panel(PIC_PANEL_UPDATE, address >> 1, data);
		return;
	case PIC_REGIONCONFIG:
		{
		uint32_t i = (address - pic24_map[pic24_index].configaddr) >> 1;
		pic24_conf.config[i] = (data & PIC24_CONFIG_MASK) | PIC24_CONFIG_PENDING;
		}
		return;
	case PIC_REGIONID:
		{
		uint32_t i = (address - pic24_map[pic24_index].fuidaddr) >> 1;
		pic24_conf.fuid[i] = (data & PIC24_CONFIG_MASK) | PIC24_CONFIG_PENDING;
		}
		return;
	}
	if (p.f)
		fprintf(p.f, "%s: warning: region unsupported [%d]\n", __func__, region);
}

/*
 * INIT REGION FOR VERIFY
 *
 *  RETURN REGION IF VERIFY SUPPORTED
 */
static inline uint32_t
pic24_init_verifyregion(uint32_t region)
{
	if (region != PIC_REGIONNOTSUP) {
		return region;
	}
	if (p.f)
		printf("%s: warning: region unsupported [%d]\n", __func__, region);
	return PIC_REGIONNOTSUP;
}

/*
 * VERIFY REGION
 *
 *  RETURN BYTE FAILURE COUNT
 */
static inline uint32_t
pic24_verifyregion(uint32_t address, uint32_t region, uint16_t index, uint32_t wdata)
{
	uint32_t vdata = 0;

	if (region == PIC_REGIONNOTSUP) {
		if (p.f)
			fprintf(p.f, "%s: warning: region unsupported [%d]\n",
				__func__, region);
		return wdata;
	} else if (region == PIC_REGIONCONFIG) {
		/* Can't verify config */
		return wdata;
	}
	if (index == 0) {
		pic24_set_read_pointer(address);
		pic24_goto200();
	}
	vdata = pic24_table_read24_post_increment();
	if (vdata != wdata && p.f) {
		fprintf(p.f, "%s: error: read [%06X] expected [%06X] at [%06X]\n",
			__func__, vdata, wdata, address);
	}
	return vdata;
}

/*****************************************************************************
 *
 * Program & verify
 *
 *****************************************************************************/

/*
 * BEGIN PROGRAMMING
 */
void
pic24_program_begin(void)
{
	pic24_program_verify();
	pic24_write_program_init();
}

/*
 * PROGRAM DATA
 */
uint32_t
pic24_program_data(uint32_t current_region, pic_data *pdata)
{
	uint32_t address, new_region, wdata;

	for (uint32_t i = 0; i < pdata->nbytes; i += 4) {
		address = (pdata->address + i) >> 1;
		new_region = pic24_getregion(address);
		if (new_region != current_region) {
		        pic_write_panel(PIC_PANEL_END, PIC_VOID, PIC_VOID);
		        current_region = pic24_init_writeregion(new_region);
		}
		if (current_region == PIC_REGIONNOTSUP)
			continue;
		wdata = pdata->bytes[i] |
			(pdata->bytes[i + 1] << 8) |
			(pdata->bytes[i + 2] << 16);
		pic24_writeregion(address, current_region, wdata);
	}
	return current_region;
}

/*
 * END PROGRAMMING
 */
void
pic24_program_end(int config)
{
	pic_write_panel(PIC_PANEL_END, PIC_VOID, PIC_VOID);
	pic24_standby();
	if (config)
		pic24_write_config();
}

/*
 * VERIFY DATA
 */
uint32_t
pic24_verify_data(uint32_t current_region, pic_data *pdata, uint32_t *fail)
{
	uint32_t address, new_region, wdata, vdata;

	for (uint32_t i = 0; i < pdata->nbytes; i += 4) {
		address = (pdata->address + i) >> 1;
		new_region = pic24_getregion(address);
		if (new_region != current_region)
			current_region = pic24_init_verifyregion(new_region);
		if (current_region == PIC_REGIONNOTSUP)
			continue;
		wdata = pdata->bytes[i] |
			(pdata->bytes[i + 1] << 8) |
			(pdata->bytes[i + 2] << 16);
		vdata = pic24_verifyregion(address, current_region, i, wdata);
		if (vdata != wdata) {
			pdata->bytes[i] = vdata;
			pdata->bytes[i + 1] = vdata >> 8;
			pdata->bytes[i + 2] = vdata >> 16;
			(*fail) += 4;
		}
	}
	return current_region;
}

/*
 * VIEW DATA
 */
void
pic24_view_data(pic_data *pdata)
{
	uint32_t wdata;

	printf("[%06X] ", pdata->address >> 1);
	for (uint32_t i = 0; i < pdata->nbytes; i += 4) {
		wdata = pdata->bytes[i] |
			(pdata->bytes[i + 1] << 8) |
			(pdata->bytes[i + 2] << 16);
		printf("%06X ", wdata);
	}
	putchar('\n');
}

/*****************************************************************************
 *
 * Diagnostic functions
 *
 *****************************************************************************/

/*
 * DUMP DEVICE ID DETAILS
 */
void
pic24_dumpdeviceid(void)
{
	printf("[000000] [PROGRAM]  %04X WORDS\n", pic24_map[pic24_index].flash);
	uint32_t eaddr;
	if (pic24_get_data_size(&eaddr)) {
		printf("[%06X] [DATA]     %04X BYTES\n",
			eaddr, pic24_map[pic24_index].eeprom);
	}

	/* dsPIC30F */
	if ((pic24_map[pic24_index].datasheet == DS70102H) ||		/* dsPIC30F      */
		(pic24_map[pic24_index].datasheet == DS70284B)) {	/* dsPIC30F SMPS */
		printf("[%06X] [APPID]    %02X\n", dsPIC30F_APPID_ADDR, 0xFF & pic24_conf.appid);
		for (uint32_t i = 0; i < 32; i += 4) {
			printf("[%06X] [UNIT%02X]   %04X %04X %04X %04X\n", pic24_map[pic24_index].fuidaddr + 2 * i, i,
				0xFFFF & pic24_conf.fuid[i + 0], 0xFFFF & pic24_conf.fuid[i + 1],
				0xFFFF & pic24_conf.fuid[i + 2], 0xFFFF & pic24_conf.fuid[i + 3]);
		}
		pic24_dumpconfig(PIC_BRIEF);
		int16_t id  = (pic24_conf.deviceid & dsPIC30F_MASK) >> 6;
		int16_t var = (pic24_conf.deviceid & dsPIC30F_VAR_MASK);
		printf("[%06X] [DEVID]    %04X MASK:%03X VAR:%02X %s\n",
			PIC24_DEVID, pic24_conf.deviceid, id, var, pic24_map[pic24_index].devicename);
		int16_t proc = (pic24_conf.revision & dsPIC30F_PROC_MASK) >> 12;
		int16_t rev  = (pic24_conf.revision & dsPIC30F_REV_MASK) >> 6;
		int16_t dot  = (pic24_conf.revision & dsPIC30F_DOT_MASK);
		printf("[%06X] [DEVREV]   %04X PROC:%X REV:%1X DOT:%1X\n",
			PIC24_DEVREV, pic24_conf.revision, proc, rev, dot);
	}

	/* dsPIC33F/PIC24H */
	else if (pic24_map[pic24_index].datasheet == DS70152H) {
		printf("[%06X] [APPID]    %02X\n", PIC24_APPID_ADDR, 0xFF & pic24_conf.appid);
		for (uint32_t i = 0; i < pic24_map[pic24_index].ncalib; ++i) {
			printf("[%06X] [CALIB%d]   %06X\n", pic24_map[pic24_index].calibaddr + 2 * i,
				i + 1, pic24_conf.calib[i]);
		}
		pic24_dumpconfig(PIC_BRIEF);
		for (uint32_t i = 0; i < pic24_map[pic24_index].nfuid; ++i) {
			printf("[%06X] [FUID%d]    %02X\n",
				pic24_map[pic24_index].fuidaddr + 2 * i, i, 0xFF & pic24_conf.fuid[i]);
		}
		printf("[%06X] [DEVID]    %04X %s\n",
			PIC24_DEVID, pic24_conf.deviceid, pic24_map[pic24_index].devicename);
		printf("[%06X] [DEVREV]   %04X\n",
			PIC24_DEVREV, pic24_conf.revision);
	}

	/* PIC24F KA KL/KM */
	else if (pic24_map[pic24_index].datasheet == DS39919C ||
		 pic24_map[pic24_index].datasheet == DS30625D) {
		printf("[%06X] [APPID]    %02X\n", PIC24_APPID_ADDR, 0xFF & pic24_conf.appid);
		for (uint32_t i = 0; i < pic24_map[pic24_index].ncalib; ++i) {
			printf("[%06X] [CALIB%d]   %06X\n", pic24_map[pic24_index].calibaddr + 2 * i,
				i + 1, pic24_conf.calib[i]);
		}
		pic24_dumpconfig(PIC_BRIEF);
		int16_t family = (pic24_conf.deviceid & 0xFF00) >> 8;
		int16_t device = (pic24_conf.deviceid & 0x00FF);
		printf("[%06X] [DEVID]    %04X FAM:%02X DEV:%02X %s\n",
			PIC24_DEVID, pic24_conf.deviceid, family, device, pic24_map[pic24_index].devicename);
		int16_t rev = (pic24_conf.revision & 0x0F);
		printf("[%06X] [DEVREV]   %04X REV:%1X\n",
			PIC24_DEVREV, pic24_conf.revision, rev);
	}

	/* dsPIC33F/PIC24FJXXMC with volatile config */
	else if (pic24_map[pic24_index].datasheet == DS70659C || pic24_map[pic24_index].datasheet == DS75012B) {
		pic24_dumpconfig(PIC_BRIEF);
		printf("[%06X] [APPID]    %02X\n", PIC24_APPID_ADDR, 0xFF & pic24_conf.appid);
		printf("[%06X] [DEVID]    %04X %s\n",
			PIC24_DEVID, pic24_conf.deviceid, pic24_map[pic24_index].devicename);
		printf("[%06X] [DEVREV]   %04X\n",
			PIC24_DEVREV, pic24_conf.revision);
	}

	/* PIC24F with 2 volatile config words */
	else if (pic24_map[pic24_index].datasheet == DS39786D) {
		pic24_dumpconfig(PIC_BRIEF);
		printf("[%06X] [APPID]    %02X\n", PIC24_APPID_ADDR, 0xFF & pic24_conf.appid);
		for (uint32_t i = 0; i < pic24_map[pic24_index].ncalib; ++i) {
			printf("[%06X] [CALIB%d]   %06X\n", pic24_map[pic24_index].calibaddr + 2 * i,
				i + 1, pic24_conf.calib[i]);
		}
		int16_t family = (pic24_conf.deviceid & PIC24FJ_FAMILY_MASK) >> 6;
		int16_t device = (pic24_conf.deviceid & PIC24FJ_DEV_MASK);
		printf("[%06X] [DEVID]    %04X FAM:%02X DEV:%02X %s\n",
			PIC24_DEVID, pic24_conf.deviceid, family, device, pic24_map[pic24_index].devicename);
		int16_t major = (pic24_conf.revision & PIC24FJ_MAJRV_MASK) >> 6;
		int16_t dot   = (pic24_conf.revision & PIC24FJ_DOT_MASK);
		printf("[%06X] [DEVREV]   %04X MAJOR:%1X DOT:%1X\n",
			PIC24_DEVREV, pic24_conf.revision, major, dot);
	}

	/* PIC24F with 4 volatile config words */
	else if (pic24_map[pic24_index].datasheet == DS39934B ||
		pic24_map[pic24_index].datasheet == DS30000510E) {
		pic24_dumpconfig(PIC_BRIEF);
		printf("[%06X] [APPID]    %02X\n", PIC24_APPID_ADDR, 0xFF & pic24_conf.appid);
		for (uint32_t i = 0; i < pic24_map[pic24_index].ncalib; ++i) {
			printf("[%06X] [CALIB%d]   %06X\n", pic24_map[pic24_index].calibaddr + 2 * i,
				i + 1, pic24_conf.calib[i]);
		}
		int16_t family = (pic24_conf.deviceid & 0xFF00) >> 8;
		int16_t device = (pic24_conf.deviceid & 0x00FF);
		printf("[%06X] [DEVID]    %04X FAM:%02X DEV:%02X %s\n",
			PIC24_DEVID, pic24_conf.deviceid, family, device, pic24_map[pic24_index].devicename);
		int16_t rev = (pic24_conf.revision & 0x0F);
		printf("[%06X] [DEVREV]   %04X REV:%1X\n",
			PIC24_DEVREV, pic24_conf.revision, rev);
	}

	/* dsPIC33EP/PIC24EP with volatile config */
	else if (pic24_map[pic24_index].datasheet == DS70663D) {
		pic24_dumpconfig(PIC_BRIEF);
		printf("[%06X] [APPID]    %02X\n", dsPIC33E_APPID_ADDR, 0xFF & pic24_conf.appid);
		for (uint32_t i = 0; i < pic24_map[pic24_index].nfuid; ++i) {
			printf("[%06X] [FUID%d]    %04X\n",
				pic24_map[pic24_index].fuidaddr + 2 * i, i, 0xFFFF & pic24_conf.fuid[i]);
		}
		printf("[%06X] [DEVID]    %04X %s\n",
			PIC24_DEVID, pic24_conf.deviceid, pic24_map[pic24_index].devicename);
		printf("[%06X] [DEVREV]   %04X\n",
			PIC24_DEVREV, pic24_conf.revision);
	}

	else {
		printf("[UNIMPLEMENTED]\n");
	}
}

/*
 * DUMP CONFIG WORD DETAILS FOR DEVICE
 */
void
pic24_dumpconfig(int mode)
{
	/* dsPIC30F */
	if (pic24_map[pic24_index].datasheet == DS70102H) {
		char config[7][10] = {
			/* 0xF80000 */ "[FOSC]",
			/* 0xF80002 */ "[FWDT]",
			/* 0xF80004 */ "[FBORPOR]",
			/* 0xF80006 */ "[FBS]",
			/* 0xF80008 */ "[FSS]",
			/* 0xF8000A */ "[FGS]",
			/* 0xF8000C */ "[FICD]"
		};
		for (uint32_t i = 0; i < pic24_map[pic24_index].nconfig; ++i) {
			printf("[%06X] %-10s %04X\n", pic24_map[pic24_index].configaddr + 2 * i,
				config[i], pic24_conf.config[i]);
		}
	}

	/* dsPIC30F SMPS */
	else if (pic24_map[pic24_index].datasheet == DS70284B) {
		char config[8][11] = {
			/* 0xF80000 */ "[FBS]",
			/* 0xF80002 */ "[RESERVED]",
			/* 0xF80004 */ "[FGS]",
			/* 0xF80006 */ "[FOSCSEL]",
			/* 0xF80008 */ "[FOSC]",
			/* 0xF8000A */ "[FWDT]",
			/* 0xF8000C */ "[FPOR]",
			/* 0xF8000E */ "[FICD]"
		};
		for (uint32_t i = 0; i < pic24_map[pic24_index].nconfig; ++i) {
			printf("[%06X] %-10s %02X\n", pic24_map[pic24_index].configaddr + 2 * i,
				config[i], 0xFF & pic24_conf.config[i]);
		}
	}

	/* dsPIC33F/PIC24H */
	else if (pic24_map[pic24_index].datasheet == DS70152H) {
		char config[9][10] = {
			/* 0xF80000 */ "[FBS]",
			/* 0xF80002 */ "[FSS]",
			/* 0xF80004 */ "[FGS]",
			/* 0xF80006 */ "[FOSCSEL]",
			/* 0xF80008 */ "[FOSC]",
			/* 0xF8000A */ "[FWDT]",
			/* 0xF8000C */ "[FPOR]",
			/* 0xF8000E */ "[FICD]",
			/* 0xF80010 */ "[FCMP]"
		};
		for (uint32_t i = 0; i < pic24_map[pic24_index].nconfig; ++i) {
			printf("[%06X] %-10s %02X\n", pic24_map[pic24_index].configaddr + 2 * i,
				config[i], 0xFF & pic24_conf.config[i]);
		}
	}

	/* PIC24F KA KL/KM */
	else if (pic24_map[pic24_index].datasheet == DS39919C ||
		 pic24_map[pic24_index].datasheet == DS30625D) {
		char config[9][11] = {
			/* 0xF80000 */ "[FBS]",
			/* 0xF80002 */ "[RESERVED]",
			/* 0xF80004 */ "[FGS]",
			/* 0xF80006 */ "[FOSCSEL]",
			/* 0xF80008 */ "[FOSC]",
			/* 0xF8000A */ "[FWDT]",
			/* 0xF8000C */ "[FPOR]",
			/* 0xF8000E */ "[FICD]",
			/* 0xF80010 */ "[FDS]"
		};
		for (uint32_t i = 0; i < pic24_map[pic24_index].nconfig; ++i) {
			printf("[%06X] %-10s %02X\n", pic24_map[pic24_index].configaddr + 2 * i,
				config[i], 0xFF & pic24_conf.config[i]);
		}
	}

	/* dsPIC33F/PIC24FJXXMC with volatile config */
	else if (pic24_map[pic24_index].datasheet == DS70659C || pic24_map[pic24_index].datasheet == DS75012B) {
		if (pic24_map[pic24_index].nconfig == 2) {
			printf("[%06X] [CONFIG2]  %04X\n",
				pic24_map[pic24_index].configaddr + 0, pic24_conf.config[0]);
			printf("[%06X] [CONFIG1]  %04X\n",
				pic24_map[pic24_index].configaddr + 2, pic24_conf.config[1]);
		} else {
			char config[8][11] = {
				/* 0x00XXF0 */ "[FICD]",
				/* 0x00XXF2 */ "[RESERVED]",
				/* 0x00XXF4 */ "[FWDT]",
				/* 0x00XXF6 */ "[FOSC]",
				/* 0x00XXF8 */ "[FOSCSEL]",
				/* 0x00XXFA */ "[FGS]",
				/* 0x00XXFC */ "[RESERVED]",
				/* 0x00XXFE */ "[RESERVED]"
			};
			for (uint32_t i = 0; i < pic24_map[pic24_index].nconfig; ++i) {
				printf("[%06X] %-10s %02X\n", pic24_map[pic24_index].configaddr + 2 * i,
					config[i], 0xFF & pic24_conf.config[i]);
			}
		}
	}

	/* PIC24F with 2 volatile config words */
	else if (pic24_map[pic24_index].datasheet == DS39786D) {
		printf("[%06X] [CONFIG2]  %04X\n",
			pic24_map[pic24_index].configaddr + 0, pic24_conf.config[0]);
		printf("[%06X] [CONFIG1]  %04X\n",
			pic24_map[pic24_index].configaddr + 2, pic24_conf.config[1]);
	}

	/* PIC24F with 4 volatile config words */
	else if (pic24_map[pic24_index].datasheet == DS39934B ||
		pic24_map[pic24_index].datasheet == DS30000510E) {
		printf("[%06X] [CONFIG4]  %04X\n",
			pic24_map[pic24_index].configaddr + 0, pic24_conf.config[0]);
		printf("[%06X] [CONFIG3]  %04X\n",
			pic24_map[pic24_index].configaddr + 2, pic24_conf.config[1]);
		printf("[%06X] [CONFIG2]  %04X\n",
			pic24_map[pic24_index].configaddr + 4, pic24_conf.config[2]);
		printf("[%06X] [CONFIG1]  %04X\n",
			pic24_map[pic24_index].configaddr + 6, pic24_conf.config[3]);
	}

	/* dsPIC33EP/PIC24EP with volatile config */
	else if (pic24_map[pic24_index].datasheet == DS70663D) {
		char config[10][11] = {
			/* 0x00XXEC */ "[RESERVED]",
			/* 0x00XXEE */ "[RESERVED]",
			/* 0x00XXF0 */ "[FICD]",
			/* 0x00XXF2 */ "[FPOR]",
			/* 0x00XXF4 */ "[FWDT]",
			/* 0x00XXF6 */ "[FOSC]",
			/* 0x00XXF8 */ "[FOSCSEL]",
			/* 0x00XXFA */ "[FGS]",
			/* 0x00XXFC */ "[RESERVED]",
			/* 0x00XXFE */ "[RESERVED]"
		};
		for (uint32_t i = 0; i < pic24_map[pic24_index].nconfig; ++i) {
			printf("[%06X] %-10s %02X\n", pic24_map[pic24_index].configaddr + 2 * i,
				config[i], 0xFF & pic24_conf.config[i]);
		}
	}

	else {
		printf("[UNIMPLEMENTED]\n");
	}

#ifdef VERBOSE
	if (mode == PIC_VERBOSE)
		pic24_dumpconfig_verbose();
#endif
}

/*
 * DUMP VERBOSE CONFIG WORD DETAILS FOR DEVICE
 */
#ifdef VERBOSE
void
pic24_dumpconfig_verbose(void)
{
	/* UNIMPLEMENTED */
}
#endif /* VERBOSE */

/*
 * DUMP HEX FLASH WORDS
 */
void
pic24_dumphexcode(uint32_t address, uint32_t size, uint32_t *data)
{
	uint32_t i, j, nlines = 0;

	for (i = 0; i < size; address += 16, i += 8) {
#ifndef DEBUG
		if (pic_mtcode(PIC24_MASK, 8, &data[i]))
			continue;
#endif
		printf("[%06X] ", address);
		for (j = 0; j < 8; ++j)
			printf("%06X ", data[i + j] & PIC24_MASK);
		for (j = 0; j < 8; ++j) {
			putchar(PIC_CHAR(0xFF & data[i + j]));
			putchar(PIC_CHAR(0xFF & (data[i + j] >> 8)));
			putchar(PIC_CHAR(0xFF & (data[i + j] >> 16)));
		}
		putchar('\n');
		nlines++;
	}
	if (!nlines)
		printf("%s: information: flash empty\n", __func__);
}

/*
 * DUMP INHX32 FLASH WORDS
 */
void
pic24_dumpinhxcode(uint32_t address, uint32_t size, uint32_t *data)
{
	uint32_t i, j;

	/* PIC24: Extended address */
	pic_dumpaddr(address << 1, 1);

	for (i = 0; i < size; address += 8, i += 4) {
		if (pic_mtcode(PIC24_MASK, 4, &data[i]))
			continue;
		/* PIC24: Extended address */
		pic_dumpaddr(address << 1, 0);

		uint8_t cc, hb, mb, lb;
		mb = address >> 7;
		lb = address << 1;
		printf(":%02X%02X%02X00", 16, mb, lb);
		cc = 16 + mb + lb + 0x00;
		for (j = 0; j < 4; ++j) {
			lb = data[i + j];
			mb = data[i + j] >> 8;
			hb = data[i + j] >> 16;
			printf("%02X%02X%02X00", lb, mb, hb);
			cc = cc + lb + mb + hb + 0x00;
		}
		printf("%02X\n", (0x0100 - cc) & 0xFF);
	}
}

/*
 * DUMP HEX DATA EEPROM WORDS
 */
void
pic24_dumphexdata(uint32_t address, uint32_t size, uint16_t *data)
{
	uint32_t i, j, nlines = 0;

	for (i = 0; i < (size / 2); address += 16, i += 8) {
		if (pic_mtdata(0xFFFF, 8, &data[i]))
			continue;
		printf("[%06X] ", address);
		for (j = 0; j < 8; ++j)
			printf("%04X ", data[i + j]);
		for (j = 0; j < 8; ++j) {
			putchar(PIC_CHAR(0xFF & data[i + j]));
			putchar(PIC_CHAR(0xFF & (data[i + j] >> 8)));
		}
		putchar('\n');
		nlines++;
	}
	if (!nlines)
		printf("%s: information: data empty\n", __func__);
}

/*
 * DUMP INHX32 DATA EEPROM WORDS
 */
void
pic24_dumpinhxdata(uint32_t address, uint32_t size, uint16_t *data)
{
	uint32_t i, j;

	/* PIC24: Extended address */
	pic_dumpaddr(address << 1, 1);

	for (i = 0; i < (size / 2); address += 8, i += 4) {
		if (pic_mtdata(0xFFFF, 4, &data[i]))
			continue;
		/* PIC24: Extended address */
		pic_dumpaddr(address << 1, 0);

		uint8_t cc, mb, lb;
		mb = address >> 7;
		lb = address << 1;
		printf(":%02X%02X%02X00", 16, mb, lb);
		cc = 16 + mb + lb + 0x00;
		for (j = 0; j < 4; ++j) {
			lb = data[i + j];
			mb = data[i + j] >> 8;
			printf("%02X%02X0000", lb, mb);
			cc = cc + lb + mb + 0x00 + 0x00;
		}
		printf("%02X\n", (0x0100 - cc) & 0xFF);
	}
}

/*
 * DUMP INHX32 DEVICE CONFIGURATION
 */
void
pic24_dumpdevice(void)
{
	if (pic24_map[pic24_index].fuidaddr) {
		/* PIC24: Extended address */
		pic_dumpaddr(pic24_map[pic24_index].fuidaddr << 1, 1);

		/* FUID */
		for (uint32_t i = 0; i < pic24_map[pic24_index].nfuid; ++i) {
			pic_dumpword32(pic24_map[pic24_index].fuidaddr + 2 * i, pic24_conf.fuid[i]);
		}
	}
	if (pic24_map[pic24_index].configaddr == PIC24_CONFIG_ADDR) {
		/* PIC24: Extended address */
		pic_dumpaddr(pic24_map[pic24_index].configaddr << 1, 1);

		/* CONFIG */
		for (uint32_t i = 0; i < pic24_map[pic24_index].nconfig; ++i) {
			pic_dumpword32(pic24_map[pic24_index].configaddr + 2 * i, pic24_conf.config[i]);
		}
	}
}
